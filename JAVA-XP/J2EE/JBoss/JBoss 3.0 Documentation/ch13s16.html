<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>How to Integrate a Web Container into JBoss</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets Vimages/callouts/"><link rel="home" href="index.html" title="JBoss 3.0 Documentation"><link rel="up" href="ch13.html" title="Chapter 13. HOWTO"><link rel="previous" href="ch13.html" title="Chapter 13. HOWTO"><link rel="next" href="ch13s21.html" title="How to use Applets to access EJBs in JBoss"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table border="0" cellpadding="0" cellspacing="0" height="65"><tr height="65"><td rowspan="2"><img src="images\jboss.gif" border="0"></td><td rowspan="2" background="images\gbar.gif" width="100%" align="right" valign="top"><a href="index.html"><img src="images\doc.gif" border="0"></a><a href="ch13.html"><img src="images\toc.gif" border="0"></a><a href="ch13.html"><img src="images\prev.gif" border="0"></a><a href="ch13s21.html"><img src="images\next.gif" border="0"></a></td></tr><tr></tr></table><div class="section"><a name="howto.webcontainer"></a><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="howto.webcontainer"></a>How to Integrate a Web Container into JBoss</h2></div></div><p>Author:<span class="author">Scott Stark</span> 
		<tt>&lt;<a href="mailto:Scott_Stark@displayscape.com">Scott_Stark@displayscape.com</a>&gt;</tt>
	</p><div class="section"><a name="d0e9320"></a><div class="titlepage"><div><h3 class="title"><a name="d0e9320"></a>Introduction</h3></div></div><p>This HowTo describes the steps for integrating a third party web container into the JBoss application server framework. A web container is a J2EE server component that enables access to servlets and JSP pages. Example servlet containers include Tomcat and Jetty. Integrating a servlet container into JBoss consists of mapping web-app.xml JNDI information into the JBoss JNDI namespace using an optional jboss-web.xml descriptor as well as delegating authentication and authorization to the JBoss security layer. These tasks are simplified by the org.jboss.web.AbstractWebContainer class. The remainder of this HowTo describes howto integrate a web container using the AbstractWebContainer class.</p></div><div class="section"><a name="d0e9325"></a><div class="titlepage"><div><h3 class="title"><a name="d0e9325"></a>AbstractWebContainer Overview</h3></div></div><p>The org.jboss.web.AbstractWebContainer class is an implementation of a template pattern for web container integration into JBoss. This class should be subclassed by web container providers wishing to integrate their container into a JBoss server. AbstractWebContainer provides support for parsing the standard J2EE web-app.xml web application deployment descriptor JNDI and security elements as well as support for parsing the JBoss specific jboss-web.xml descriptor. The AbstractWebContainer is an abstract class that implements the AbstractWebContainerMBean JMX mbean interface used by the JBoss deployer when war files need to be deployed. <a href="ch13s16.html#howto.webcontainer.AbstractWebContainer" title="Figure 13.1. Key AbstractWebContainer Class Methods">Figure 13.1</a> presents some of the key AbstractWebContainer methods.</p><div class="figure"><p><a name="howto.webcontainer.AbstractWebContainer"></a><b>Figure 13.1. Key AbstractWebContainer Class Methods</b></p><pre class="programlisting">
package org.jboss.web;
...

public abstract class AbstractWebContainer extends ServiceMBeanSupport implements AbstractWebContainerMBean
{
<a name="howto.webcontainer.deploy"></a><img src="images\callouts\1.png" alt="1" border="0">
    public synchronized void deploy(String ctxPath, String warUrl) throws DeploymentException
    {
            WebApplication warInfo = performDeploy(ctxPath, warUrl);
            ClassLoader loader = warInfo.getClassLoader();
            Element webApp = warInfo.getWebApp();
            Element jbossWeb = warInfo.getJbossWeb();
            parseWebAppDescriptors(loader, webApp, jbossWeb);
            deploymentMap.put(warUrl, warInfo);
    }
<a name="howto.webcontainer.performDeploy"></a><img src="images\callouts\2.png" alt="2" border="0">
    protected abstract WebApplication performDeploy(String ctxPath, String warUrl) throws Exception;

<a name="howto.webcontainer.undeploy"></a><img src="images\callouts\3.png" alt="3" border="0">
    public synchronized void undeploy(String warUrl) throws DeploymentException
    {
            performUndeploy(warUrl);
            // Remove the web application ENC...
            deploymentMap.remove(warUrl);
    }
<a name="howto.webcontainer.performUndeploy"></a><img src="images\callouts\4.png" alt="4" border="0">
    protected abstract void performUndeploy(String warUrl) throws Exception;

    public boolean isDeployed(String warUrl)
    {
        return deploymentMap.containsKey(warUrl);
    }

    public WebApplication getDeployedApp(String warUrl)
    {
        WebApplication appInfo = (WebApplication) deploymentMap.get(warUrl);
        return appInfo;
    }

<a name="howto.webcontainer.parseWebAppDescriptors"></a><img src="images\callouts\5.png" alt="5" border="0">
    private void parseWebAppDescriptors(ClassLoader loader, Element webApp, Element jbossWeb) throws Exception
    {
        WebMetaData metaData = new WebMetaData();
        metaData.importXml(webApp);
        if( jbossWeb != null )
            metaData.importXml(jbossWeb);
        ...
        addEnvEntries(envEntries, envCtx);
        Iterator resourceRefs = metaData.getResourceReferences();
        linkResourceRefs(resourceRefs, envCtx);
        Iterator ejbRefs = metaData.getEjbReferences();
        linkEjbRefs(ejbRefs, envCtx);
        String securityDomain = metaData.getSecurityDomain();
        linkSecurityDomain(securityDomain, envCtx);
    }

<a name="howto.webcontainer.addEnvEntries"></a><img src="images\callouts\6.png" alt="6" border="0">
    protected void addEnvEntries(Iterator envEntries, Context envCtx)
        throws ClassNotFoundException, NamingException
    {
        ...
    }

<a name="howto.webcontainer.linkResourceRefs"></a><img src="images\callouts\7.png" alt="7" border="0">
    protected void linkResourceRefs(Iterator resourceRefs, Context envCtx)
        throws NamingException
    {
        ...
    }

<a name="howto.webcontainer.linkEjbRefs"></a><img src="images\callouts\8.png" alt="8" border="0">
    protected void linkEjbRefs(Iterator ejbRefs, Context envCtx)
        throws NamingException
    {
        ...
    }

<a name="howto.webcontainer.linkSecurityDomain"></a><img src="images\callouts\9.png" alt="9" border="0">
    protected void linkSecurityDomain(String securityDomain, Context envCtx)
        throws NamingException
    {
        ...
    }

}

</pre><pre class="programlisting">public class WebApplication
{
    /** Class loader of this application */
    ClassLoader classLoader = null;
    /** name of this application */
    String name = "";
    /** URL where this application was deployed from */
    URL url;
    /** The root element of thw web-app.xml descriptor. */
    Element webApp;
    /** The root element of thw jboss-web.xml descriptor. */
    Element jbossWeb;
    /** Arbitary data object for storing application specific data */
    Object data;
...
	// WebApplication property getters/setters...
}</pre></div><div class="calloutlist"><a name="d0e9357"></a><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="d0e9358"></a><a href="#howto.webcontainer.deploy"><img src="images\callouts\1.png" alt="1" border="0"></a> </td><td valign="top" align="left"><p>A template pattern implementation of the deploy() method. This method
     calls the performDeploy() method to
     perform the container specific deployment steps and registers the
     returned WebApplication in the deployment map. The steps performed are:

        WebApplication warInfo = performDeploy(ctxPath, warUrl);
        ClassLoader loader = warInfo.getClassLoader();
        Element webApp = warInfo.getWebApp();
        Element jbossWeb = warInfo.getJbossWeb();
        parseWebAppDescriptors(loader, webApp, jbossWeb);
        deploymentMap.put(warUrl, warInfo);

     @param ctxPath, The context-root element value from the J2EE
        application/module/web application.xml descriptor. This may be null
        if war was is not being deployed as part of an enterprise application.
     @param warUrl, The string for the URL of the web application war.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="d0e9361"></a><a href="#howto.webcontainer.performDeploy"><img src="images\callouts\2.png" alt="2" border="0"></a> </td><td valign="top" align="left"><p>The method is called by the deploy() method and must be overriden by
subclasses to perform the web container specific deployment steps. A WebApplication object must
be returned that contains the web application class loader, web-app.xml web-app document element
and the jboss-web.xml jboss-web document element if a jboss-web.xml existed in the war.
     @param ctxPath, The context-root element value from the J2EE
        application/module/web application.xml descriptor. This may be null
        if war was is not being deployed as part of an enterprise application.
     @param warUrl, The string for the URL of the web application war.
     @return WebApplication, the web application information required by the
        AbstractWebContainer class to setup the JNDI ENC and track the war
        deployment status.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="d0e9364"></a><a href="#howto.webcontainer.undeploy"><img src="images\callouts\3.png" alt="3" border="0"></a> </td><td valign="top" align="left"><p>A template pattern implementation of the undeploy() method. This method
calls the subclass performUndeploy() method to perform the container specific undeployment steps and unregisters the
the warUrl from the deployment map.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="d0e9367"></a><a href="#howto.webcontainer.performUndeploy"><img src="images\callouts\4.png" alt="4" border="0"></a> </td><td valign="top" align="left"><p>performUndeploy</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="d0e9370"></a><a href="#howto.webcontainer.parseWebAppDescriptors"><img src="images\callouts\5.png" alt="5" border="0"></a> </td><td valign="top" align="left"><p> This method is called as part of the deploy() method template to
        parse the web-app.xml and jboss-web.xml deployment descriptors from a
        war deployment. The method creates the ENC(java:comp/env) env-entry,
        resource-ref, and ejb-ref element values. The creation of the env-entry
        values does not require a jboss-web.xml descriptor. The creation of the
        resource-ref and ejb-ref elements does require a jboss-web.xml descriptor
        for the JNDI name of the deployed resources/EJBs.

        Because the ENC context is private to the web application, the web
        application class loader is used to identify the ENC. The class loader
        is used because each war typically requires a unique class loader to
        isolate the web application classes/resources. This means that the
        ClassLoader passed to this method must be the thread context ClassLoader
        seen by the server/jsp pages during init/destroy/service/etc. method
        invocations if these methods interace with the JNDI ENC context.

    @param loader, the ClassLoader for the web application. May not be null.
    @param webApp, the root element of thw web-app.xml descriptor. May not be null.
    @param jbossWeb, the root element of thw jboss-web.xml descriptor. May be null
        to indicate that no jboss-web.xml descriptor exists.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="d0e9373"></a><a href="#howto.webcontainer.addEnvEntries"><img src="images\callouts\6.png" alt="6" border="0"></a> </td><td valign="top" align="left"><p>The addEnvEntries creates the java:comp/env web container
env-entry bindings that were specified in the web-app.xml descriptor.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="d0e9376"></a><a href="#howto.webcontainer.linkResourceRefs"><img src="images\callouts\7.png" alt="7" border="0"></a> </td><td valign="top" align="left"><p>The linkResourceRefs method maps the java:comp/env/xxx web container
JNDI ENC resource elements onto the deployed JNDI names using the mappings specified in the
jboss-web.xml descriptor</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="d0e9379"></a><a href="#howto.webcontainer.linkEjbRefs"><img src="images\callouts\8.png" alt="8" border="0"></a> </td><td valign="top" align="left"><p>The linkEjbRefs method maps the java:comp/env/ejb web container
JNDI ENC ejb elements onto the deployed JNDI names using the mappings specified in the
jboss-web.xml descriptor.</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="d0e9382"></a><a href="#howto.webcontainer.linkSecurityDomain"><img src="images\callouts\9.png" alt="9" border="0"></a> </td><td valign="top" align="left"><p>This creates a java:comp/env/security context that contains a
        securityMgr binding pointing to an EJBSecurityMgr implementation
        and a realmMapping binding pointing to a RealmMapping implementation.
        If the jboss-web.xml descriptor contained a security-domain element
        then the bindings are LinkRefs to the jndi name specified by the
        security-domain element. If there was no security-domain element then
        the bindings are to NullSecurityManager instance which simply allows
        all access.</p></td></tr></table></div></div><div class="section"><a name="howto.webcontainer.Subclassing"></a><div class="titlepage"><div><h3 class="title"><a name="howto.webcontainer.Subclassing"></a>Integrating a Web Container by Subclassing AbstractWebContainer</h3></div></div><p>To integrate your web container into JBoss create a subclass of AbstractWebContainer and implement
the required performDeploy(String, String) and performUndeploy(String) methods. See the performDeploy and performUndeploy
method notes in the preceeding section for details of the method implementations.</p></div><div class="section"><a name="howto.webcontainer.Security"></a><div class="titlepage"><div><h3 class="title"><a name="howto.webcontainer.Security"></a>Delegating Web Container Authentication and Authorization to JBoss</h3></div></div><p>Ideally both web application and ejb authentication and authorization is handled
by the same security code. To enable this for your web container you must hook into the JBoss security
layer. This typically requires a request interceptor that maps from the web container security callouts
to the JBoss security api calls. Integration with the JBossSX security framework is based on the establishment
of a java:comp/env/security context as described in the linkSecurityDomain(String, Context) method comments
in the overview section. The security context provides access to the JBossSX security mgr interface
implementations for use by subclass request interceptors. A outline of the steps for authenticating a user is:<div class="example"><p><a name="d0e9395"></a><b>Example 13.1. Authentication Steps</b></p><pre class="programlisting">    // Get the username and password from the request context...
    String username = f(request);
    String password = f(request);
    // Get the JBoss security manager from the ENC context
    InitialContext iniCtx = new InitialContext();
    EJBSecurityManager securityMgr = (EJBSecurityManager) iniCtx.lookup("java:comp/env/security/securityMgr");
    SimplePrincipal principal = new SimplePrincipal(username);
    if( securityMgr.isValid(principal, password) )
    {
        // Indicate the user is allowed access to the web content...
        
        // Propagate the user info to JBoss for any calls into made by the servlet
        SecurityAssociation.setPrincipal(principal);
        SecurityAssociation.setCredential(password.toCharArray());
    }
    else
    {
        // Deny access...
    }</pre></div>An outline of the steps for authorizing a user with the JBossSX api is:<div class="example"><p><a name="d0e9401"></a><b>Example 13.2. Authorization Steps</b></p><pre class="programlisting">    // Get the username and required roles from the request context...
    String username = f(request);
    String[] roles = f(request);
    // Get the JBoss security manager from the ENC context
    InitialContext iniCtx = new InitialContext();
    RealmMapping securityMgr = (RealmMapping) iniCtx.lookup("java:comp/env/security/realmMapping");
    SimplePrincipal principal = new SimplePrincipal(username);
    Set requiredRoles = new HashSet(Arrays.asList(roles));
    if( securityMgr.doesUserHaveRole(principal, requiredRoles) )
    {
        // Indicate the user has the required roles for the web content...
    }
    else
    {
        // Deny access...
    }</pre></div>
		</p></div></div><table border="0" cellpadding="0" cellspacing="0" height="65"><tr height="65"><td rowspan="2"><img src="images\gbar.gif" width="432" height="79"></td><td rowspan="2" background="images\gbar.gif" width="100%" align="right" valign="top"><a href="index.html"><img src="images\doc.gif" border="0"></a><a href="ch13.html"><img src="images\toc.gif" border="0"></a><a href="ch13.html"><img src="images\prev.gif" border="0"></a><a href="ch13s21.html"><img src="images\next.gif" border="0"></a></td></tr><tr></tr></table></body></html>