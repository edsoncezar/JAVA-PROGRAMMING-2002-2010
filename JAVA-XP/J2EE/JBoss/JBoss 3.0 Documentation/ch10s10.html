<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>
        How to Run and Debug EJBs using jBoss 2.2.2 inside of 
        Visual Age for Java version 3.5 (patch 2)
</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets Vimages/callouts/"><link rel="home" href="index.html" title="JBoss 3.0 Documentation"><link rel="up" href="ch10.html" title="Chapter 10. Development Tools and IDE Integration"><link rel="previous" href="ch10.html" title="Chapter 10. Development Tools and IDE Integration"><link rel="next" href="ch10s14.html" title="Integrating NetBeans/Forte for Java Community Edition with JBoss &#xA;for source level debugging"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table border="0" cellpadding="0" cellspacing="0" height="65"><tr height="65"><td rowspan="2"><img src="images\jboss.gif" border="0"></td><td rowspan="2" background="images\gbar.gif" width="100%" align="right" valign="top"><a href="index.html"><img src="images\doc.gif" border="0"></a><a href="ch10.html"><img src="images\toc.gif" border="0"></a><a href="ch10.html"><img src="images\prev.gif" border="0"></a><a href="ch10s14.html"><img src="images\next.gif" border="0"></a></td></tr><tr></tr></table><div class="section"><a name="vajdebug"></a><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="vajdebug"></a>
        How to Run and Debug EJBs using jBoss 2.2.2 inside of 
        Visual Age for Java version 3.5 (patch 2)
</h2></div></div><p>
        Author:
        <span class="author">Craig Doremus</span>
		<tt>&lt;<a href="mailto:cdoremus@vianow.com">cdoremus@vianow.com</a>&gt;</tt>
        <span class="author">Alex Lee</span>
		<tt>&lt;<a href="mailto:chiewkwooi@hotmail.com">chiewkwooi@hotmail.com</a>&gt;</tt>
	</p><p>Importing jBoss into Visual Age for Java (VAJ) allows you to develop and
debug EJBs using the latest Enterprise Java Beans standard (version 1.1 and Message Driven EJBs). 
The Enterprise version of Visual Age has built-in EJB debugging, but that 
edition of the IDE only supports version 1.0 of the EJB spec.  Currently, Visual Age only 
supports JDK 1.2.2.
</p><p>
        We created a jBoss Test Environment by manually importing jBoss source 
        into Visual Age for Java. This import also 
        involved a few code hacks to remove JDK 1.3 
        code, to change the paths to configuration files and some
       modification of paths inside of configuration files. 
</p><p>
        Our jBoss import does not include an integrated 
        <a href="http://jakarta.apache.org/tomcat/index.html" target="_top">Jakarta-Tomcat</a> servlet engine.
        IBM provides a Test Environment for Tomcat version 3.1 on their web site <a href="http://www7.software.ibm.com/vad.nsf/Data/Document2390?OpenDocument&p=1&BCT=3&Footer=1" target="_top">here</a>, 
        that allows debugging of JSP and servlets inside of VAJ. Both Tomcat
        and jBoss can be run inside of VAJ to provide the ability to debug EJBs
        called by servlets.
</p><div class="section"><a name="vajdebug-requirements"></a><div class="titlepage"><div><h3 class="title"><a name="vajdebug-requirements"></a>Requirements</h3></div></div><div class="itemizedlist"><ul><li><p><a name="d0e6871"></a>Visual Age for Java Professional or Enterprise Edition Version 3.5 with patch 2 installed. Version 3.5.3 has recently been released, but there are some RMI bugs in it so we can't recommend using it at this time.</p></li><li><p><a name="d0e6874"></a>JBoss-2.2.2.zip downloaded (NOT the one with integrated Tomcat) <a href="http://prdownloads.sourceforge.net/jboss/JBoss-2.2.2.zip" target="_top">Download it here</a>
				</p></li></ul></div></div><div class="section"><a name="vajdebug-manualimport"></a><div class="titlepage"><div><h3 class="title"><a name="vajdebug-manualimport"></a>Manually importing jBoss 2.2.2 source code into Visual Age</h3></div></div><div class="orderedlist"><ol type="1"><li><p><a name="d0e6886"></a>Unzip JBoss-2.2.2.zip into a temporary directory.</p></li><li><p><a name="d0e6889"></a>Create a jBoss project in VAJ.	 If jBoss 2.0 is already installed, version it and delete all files and related projects before proceeding with the jBoss 2.2.2 install.
				</p></li><li><p><a name="d0e6892"></a>Import source, jar and class files into VAJ from the temporary directory including:</p><div class="orderedlist"><ol type="a"><li><p><a name="d0e6896"></a>All jBoss source (src subdirectory).
       					</p><p>Source of org.jnp.server (both *.class and *.java files) from the <a href="http://www.jboss.org/doco_files/vaj-jnpserver222.jar" target="_top">vaj-jnpserver222.jar</a> archive found in the files area on the documentation page on www.jboss.org.
</p><p>Source of org.jbossmq.* from the <a href="http://www.jboss.org/doco_files/vaj-jbossmq222.jar" target="_top">vaj-jbossmq222.jar</a> archive found in the files area on the documentation page on www.jboss.org.</p><p>org.jboss.security.SecurityAssociation source from CVS (version 1.5, which can be found <a href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/jboss/jboss/src/main/org/jboss/security/SecurityAssociation.java?rev=1.5&content-type=text/vnd.viewcvs-markup" target="_top">here)</a></p><p>org.jboss.naming.NamingService from CVS (version 1.9, which can be found <a href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/~checkout~/jboss/jboss/src/main/org/jboss/naming/NamingService.java?rev=1.9&content-type=text/x-java" target="_top">here)</a></p></li><li><p><a name="d0e6917"></a>In lib or lib/ext directory import the class files: </p><pre class="programlisting">
	All files from minerva-1_0b3.jar
	All files from jbosssx.jar
	All files from jbosscx-0.2.jar except org.jboss.resource.RARDepolyer.class, org.jboss.resource.RARDepolyer$1.class and org.jboss.resource.RARDepolyer$DeploymentInfo.class.
org.jboss.resource.RARDepolyer should be imported as source from CVS (ver 1.3) so to change tmp.properties reference (see below)
	All files in ejxejb.jar
	All files in ejxeditor.jar
	All files in awt.jar
	All files for openjms-client-patched-0.5.1.jar
	All files from openjms-pool.jar
	All files from openjms-rmi-patched-0.5.1.jar
		For organization purposes you might want to put the following class into separate projects:
	All files in jms.jar -- Java Messaging Service (into separate JMS project)
	All files in  jaas.jar -- Java's Security API (into JAAS project)
	All files in jmxri.jar -- Java Management Extension API (into JMX project)
	All files in crimson.jar (into Apache Crimson project)
	All files from xml.jar and jaxp.jar
       jdbc2_0-stdext.jar -- JDBC 2.0 Extensions
	ejb.jar -- EJB 1.1 interfaces 
	javax.ejb.MessageDrivenBean and javax.ejb.MessageDrivenContext from ejb2.0.jar 
      jndi.jar -- if not already in VAJ
NOTE: HSQL and InstantDB can be finicky and freeze upon startup of jBoss. Do not install these if they are not needed. PostgreSQL or Oracle are preferred alternatives.
      hsql.jar -- optional HSQL database.  
      jpl-util-0_5b.jar
      jta-spec1_0_1.jar -- (javax.transaction package will be updated elsewhere)
      mail.jar -- JavaMail API
      activation.jar -- Java Activation Frameworks
	connector.jar -- Java Connector Architecture
        </pre></li></ol></div></li><li><p><a name="d0e6922"></a>Directories to be added to VAJ's &lt;vaj.home&gt;/ide/project_resources/jboss directory
from jBoss zip archive:</p><pre class="programlisting">
        bin
        client
        conf/default
        db -- for InstantDB and Hypersonic
        deploy -- EJB autodeploy directory
        lib (with ext subdir) -- all the jars
        log
        tmp
</pre></li><li><p><a name="d0e6927"></a>Change the references to configuration files in the source code:</p><div class="itemizedlist"><ul><li><p><a name="d0e6931"></a>
							<span class="emphasis"><i> jboss.conf:</i></span>
						</p><p>	In org.jboss.Main.Main() add conf/default in line:</p><p>	URL mletConf = mlet.getResource("conf/default/jboss.conf") </p></li><li><p><a name="d0e6941"></a>
							<span class="emphasis"><i>jboss.jcml:</i></span>
						</p><p>In org.jboss.configuration.ConfigurationService.loadConfiguration() add conf/default in line:</p><p>InputStream conf = Thread.currentThread().getContextClassLoader().getResourceAsStream "conf/default/jboss.jcml");</p><p>In org.jboss.configuration.ConfigurationService.loadConfiguration() add conf/default in line:</p><p>conf = Thread.currentThread().getContextClassLoader().getResourceAsStream("conf/default/jboss.jcml");</p></li><li><p><a name="d0e6955"></a>
							<span class="emphasis"><i>jndi.properties</i></span>
						</p><p>org.jboss.naming.NamingService.initService() add conf/default in line:</p><p>System.getProperties().load(Thread.currentThread().getContextClassLoader().getResourceAsStream("conf/default/jndi.properties"));</p><p>org.jboss.Main.Main() add conf/default in line:</p><p>URL jndiLocation = this.getClass().getResource("conf/default/jndi.properties");</p></li><li><p><a name="d0e6969"></a>
							<span class="emphasis"><i>tmp.properties</i></span>
						</p><p>org.jboss.deployment.J2eeDeployer.initService() add /tmp in line:</p><p>URL tmpDirUrl = getClass().getResource("/tmp/tmp.properties");</p><p>org.jboss.resource.RARDeployer.initService() add /tmp in line:</p><p>URL tmpPropURL = getClass().getResource("/tmp/tmp.properties");</p></li><li><p><a name="d0e6983"></a>
							<span class="emphasis"><i>db.properties</i></span>
						</p><p>org.jboss.ejb.plugins.StatefulSessionFilePersistenceManager.init() add db/ in line:</p><p>File databaseDir = new File(getClass().getResource("db/db.properties").getFile()).getParentFile();</p><p>org.jboss.jdbc.HypersonicDatabase.startService() add /db/ in line:</p><p>URL dbLocator = getClass().getResource("/db/db.properties");</p></li><li><p><a name="d0e6997"></a>
							<span class="emphasis"><i>	standardjaws.xml</i></span>
						</p><p>org.jboss.ejb.plugins.jaws.metadata.JawsXmlFileLoader.load() add conf/default in line:</p><p>URL stdJawsUrl = classLoader.getResource("conf/default/standardjaws.xml");</p></li><li><p><a name="d0e7007"></a>
							<span class="emphasis"><i>standardjboss.xml</i></span>
						</p><p>org.jboss.metadata.XmlFileLoader.load() add conf/default in line:</p><p>URL defaultJbossUrl = Thread.currentThread().getContextClassLoader().getResource("conf/default/standardjboss.xml");</p></li><li><p><a name="d0e7017"></a>
							<span class="emphasis"><i>jnp.properties</i></span>
						</p><p>org.jnp.server.Main.Main() add conf/default in line:</p><p>System.getProperties().load(getClass().getClassLoader().getResourceAsStream("conf/default/jnp.properties"));</p></li><li><p><a name="d0e7027"></a>
							<span class="emphasis"><i>log.properties</i></span>
						</p><p>org.jboss.logging.FileLogging.openLogFile() add /log in line:</p><p>URL properties = getClass().getResource("/log/log.properties");</p></li><li><p><a name="d0e7037"></a>
							<span class="emphasis"><i>jboss-auto.jcml</i></span>
						</p><p>org.jboss.configuration.ConfigurationService.loadConfiguration() add conf/default in line:</p><p>conf = Thread.currentThread().getContextClassLoader().getResourceAsStream("conf/default/jboss-auto.jcml");</p><p>org.jboss.configuration.ConfigurationService.saveConfiguration() add conf/default in line:</p><p>URL confFile = Thread.currentThread().getContextClassLoader().getResource("conf/default/jboss-auto.jcml");</p></li><li><p><a name="d0e7051"></a>
							<span class="emphasis"><i>mail.properties</i></span>
						</p><p>org.jboss.mail.MailService.startService() add conf/default in line:</p><p>if (properties == null) {properties = "conf/default/mail.properties";}</p><p>in jboss.jcml (in VAJ's &lt;vaj.home&gt;/ide/project_resources/jboss/conf/default directory) add conf/default in mail.properties line:</p><p>				
						&lt;attribute name="ConfigurationFile"&gt;conf/default/mail.properties&lt;/attribute&gt;
							</p></li><li><p><a name="d0e7065"></a>
							<span class="emphasis"><i>jbossmq.properties</i></span>
						</p><p>org.jbossmq.Log.getLevel() add conf/default in line:</p><p>InputStream in = Thread.currentThread().getContextClassLoader().getResource("conf/default/jbossmq.properties").openStream();</p></li><li><p><a name="d0e7075"></a>
							<span class="emphasis"><i>jbossmq.xml</i></span>
						</p><p>org.jbossmq.server.JMSServer.saveConfig() add conf/default in line:</p><p>String file = getClass().getClassLoader().getResource("conf/default/jbossmq.xml").getFile();</p><p>org.jbossmq.server.StartServer.run() add conf/default in line:</p><p>InputStream in = getClass().getClassLoader().getResource("conf/default/jbossmq.xml").openStream();</p><p>org.jbossmq.persistence.PersistenceManager.PersistenceManager() add conf/default in line:</p><p>URL configFile = getClass().getClassLoader().getResource("conf/default/jbossmq.xml");</p></li></ul></div></li><li><p><a name="d0e7093"></a>Properties to change in <tt>org.jboss.Main</tt> (right click on class and
bring up Properties dialog) (NOTE -- please adjust the path to point to your Visual Age install
directory):</p><div class="orderedlist"><ol type="a"><li><p><a name="d0e7100"></a>Program tab:</p><p>1. Command line argument:</p><p>conf/default</p><p>2. Properties: (as listed)</p><p>jboss.home="e:/Program Files/Ibm/VisualAge for Java/ide/project_resources/jboss"	Note that this command line should be quoted if there are spaces in the
command line (like Program Files).</p></li><li><p><a name="d0e7111"></a>Classpath tab:</p><p>1. Project Path: Add any other projects that jBoss needs if classes it contains are not in the jBoss project.</p><p>2. Extra Directories Path:</p><div class="orderedlist"><ol type="i"><li><p><a name="d0e7119"></a>Add the following jar files from the &lt;jboss.home&gt;/lib or &lt;jboss.home&gt;/lib/etx directory : lib\ext\dynaserver.jar;lib\ext\ejxjaws.jar;lib\ext\ejxjboss.jar;lib\ext\exolabcore-0.1.jar;lib\ext\gnu-regexp-1.0.8.jar;lib\ext\jboss.jar;lib\ext\jbossmq.jar;lib\ext\jetty-service.jar;lib\ext\jmxtools.jar;lib\ext\jnpserver.jar;lib\ext\tomcat-service.jar;lib\jboss-jaas.jar</p></li><li><p><a name="d0e7122"></a>Add the following directories: "./conf/default;./db;./deploy;./log"</p></li></ol></div></li></ol></div></li><li><p><a name="d0e7125"></a>For <tt>org.jboss.jmx.connector.rmi.RMIConnectorImpl</tt>, 
<tt>org.jboss.ejb.plugins.jrmp.server.JRMPContainerInvoker</tt>,
<tt>org.jbossmq.distributed.server.ConnectionReceiverRMIImpl</tt> and <tt>org.jbossmq.distributed.server.DistributedJMSServerRMIImpl</tt>, manually generate RMI stub/skeleton using VAJ's built-in RMI tool (Right click on the class and select Tools --&gt; Generate RMI/JDK 1.2 --&gt; stubs/skeleton). You might need to temporarily move java.transaction.* into the jboss project for the rmic compiler to function without errors for JRMPContainerInvoker or directly import the RMI stub from the binary jboss.jar (org.jboss.ejb.plugins.jrmp.server.JRMPContainerInvoker_Stub.class).
        </p></li><li><p><a name="d0e7140"></a>In jboss.conf (in &lt;jboss.home&gt;/conf/default directory): </p><div class="itemizedlist"><ul><li><p><a name="d0e7144"></a>Change all references from ../../ in file to ./ using search and replace</p></li><li><p><a name="d0e7147"></a>Change references from ../xml.jar to ./xml.jar</p></li></ul></div></li><li><p><a name="d0e7150"></a>In jboss.jcml (in &lt;jboss.home&gt;/conf/default directory) 
				 change ../deploy to ./deploy in this tag:</p><pre class="programlisting">				
  &lt;mbean code="org.jboss.ejb.AutoDeployer" name="EJB:service=AutoDeployer"&gt;
    &lt;attribute name="Deployer"&gt;J2EE:service=J2eeDeployer&lt;/attribute&gt;
    &lt;attribute name="URLs"&gt;./deploy&lt;/attribute&gt;
  &lt;/mbean&gt;
	</pre><p>a. Change single reference from ../conf/default/instantdb.properties to ./conf/default/instantdb.properties</p></li><li><p><a name="d0e7157"></a>In instantdb.properties (in &lt;jboss.home&gt;/conf/default directory) change all references from ../../ to ./.</p></li><li><p><a name="d0e7160"></a>In org.jboss.util.Shutdown.preRegister(), comment out this shutdown hook code:
			</p><pre class="programlisting">
	  /* Modified by Craig since addShutdownHook is implemented in JDK 1.3
	  try
	  {
		  
		 Runtime.getRuntime().addShutdownHook(new Thread()
		 {
			public void run()
			{
			   System.out.println("Shutting down");
			   
			   // Make sure all services are down properly
			   shutdownServices();
			   
			   System.out.println("Shutdown complete");
			}
		 });
		 log.log("Shutdown hook added");
		 */
	  //} catch (Throwable e)
	  //{
		 log.error("Could not add shutdown hook");
	  //}
		
			</pre></li><li><p><a name="d0e7165"></a>Removing InstantDB from VAJ (do this if it freezes VAJ during startup). 
        			</p><p>This can be done by remove all references to InstantDB in the &lt;jboss.home&gt;/conf/default/jboss.jcml file.
        			</p></li></ol></div></div><div class="section"><a name="running-and-debugging"></a><div class="titlepage"><div><h3 class="title"><a name="running-and-debugging"></a>Running and debugging EJBs inside of Visual Age</h3></div></div><div class="orderedlist"><ol type="1"><li><p><a name="d0e7175"></a>Create META-INF subdirectory in the deploy directory of &lt;jboss.home&gt;.</p><p>a. Add ejb-jar.xml and both jboss.xml and jaws.xml (if needed) to the directory.</p></li><li><p><a name="d0e7180"></a>Run <tt>org.jboss.Main</tt> using VAJ run command to start jBoss.</p></li><li><p><a name="d0e7186"></a>Make sure any projects that contain EJBs that you are developing are in the classpath of <tt>org.jboss.Main</tt>.</p></li><li><p><a name="d0e7192"></a>If running EJBs from servlets/JSPs, make sure that jBoss's project is in Tomcat's 
classpath (the <tt>com.ibm.ivj.tomcat.TomcatRunner</tt> class). If you are calling EJBs from a client class with a main() method, make sure the jBoss project is in its 
classpath in addition to all jars from the &lt;jboss.home&gt;/client directory.
</p></li><li><p><a name="d0e7198"></a>To debug, set breakpoints inside of EJB bean class.</p></li><li><p><a name="d0e7201"></a>To allow changes to EJBs to take effect in VAJ, either restart jBoss
or touch one of the XML files in the &lt;jboss.home&gt;/deploy/META-INF directory.</p></li></ol></div></div></div><table border="0" cellpadding="0" cellspacing="0" height="65"><tr height="65"><td rowspan="2"><img src="images\gbar.gif" width="432" height="79"></td><td rowspan="2" background="images\gbar.gif" width="100%" align="right" valign="top"><a href="index.html"><img src="images\doc.gif" border="0"></a><a href="ch10.html"><img src="images\toc.gif" border="0"></a><a href="ch10.html"><img src="images\prev.gif" border="0"></a><a href="ch10s14.html"><img src="images\next.gif" border="0"></a></td></tr><tr></tr></table></body></html>