










<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<!--NewPage-->
<html>
<head>
<title>Creating the Animation Loop</title>
</head>
<body BGCOLOR="#ffffff">








<table width="100%">
<tr>
<td align=left>
<a href="animation.html"><img src="http://docs.rinet.ru/OLDui/images/PreviousArrow.gif" width=26 height=26 align=bottom border=0 alt="Previous | "></a><a
href="animgraphics.html"><img src="http://docs.rinet.ru/OLDui/images/NextArrow.gif" width=26 height=26 align=bottom border=0 alt="Next | "></a><a
href="http://docs.rinet.ru:8080/OLDui/trailmap.html"><img src="http://docs.rinet.ru/OLDui/images/WayUpArrow.gif" width=26 height=26 align=bottom border=0 alt="Trail Map | "></a><a
href="..\index.html"><img src="http://docs.rinet.ru/OLDui/images/uiHeader.gif" width=26 height=26 align=bottom border=0 alt="Creating a User Interface (AWT Only) | "></a>
</td>
<td align=right>
<a href="index.html"><strong><em>Working with Graphics</em></strong></a>
</td>
</tr>
</table>
<p>
<center>
<IMG SRC="http://docs.rinet.ru/OLDui/images/shoeline2.GIF" ALIGN="BOTTOM" BORDER="0" WIDTH="202"
    HEIGHT="25" NATURALSIZEFLAG="3">
<IMG SRC="http://docs.rinet.ru/OLDui/images/shoeline2.GIF" ALIGN="BOTTOM" BORDER="0" WIDTH="202"
    HEIGHT="25" NATURALSIZEFLAG="3">
</center>
<p> 

<h2>
    Creating the Animation Loop
</h2>
<p>
<blockquote>

Every program that performs animation 
by drawing at regular intervals
needs an animation loop.
Generally, this loop should be in its own thread.
It should <strong>never</strong> be in the 
<code>paint()</code> or <code>update()</code> method,
since that would take over the main AWT thread,
which is in charge of all drawing and event handling.

<p>

This page provides two templates for performing animation,
one for applets and another for applications.
The applet version is running just below.
You can click on it to stop the animation.
Click again to restart it.

<p>

<applet codebase=http://docs.rinet.ru:8080/OLDui/OLDui/drawing/example code=AnimatorApplet.class width=150 height=30>
<blockquote>
<hr>
<em>
Your browser can't run 1.0 Java applets,
so here is a snapshot of what you'd see:
</em>

<blockquote><IMG SRC="..\..\figures\ui\animatorapplet.gif" WIDTH="64" HEIGHT="16" ALIGN="BOTTOM" NATURALSIZEFLAG="3" ALT=""></blockquote>
<hr>
</blockquote>
</applet>

<p>

The animation the template performs is a bit boring:
it simply displays the current frame number,
using a default rate of 10 frames per second.
The next few lessons build on this example, 
showing you how to animate primitive graphics and images.

<p>

Here is the code for the 
<a href=http://docs.rinet.ru/OLDui/OLDui/drawing/example/AnimatorApplet.java>applet animation template</a>.
Here is the code for the equivalent
<a href=http://docs.rinet.ru/OLDui/OLDui/drawing/example/AnimatorApplication.java>application animation template</a>.
The rest of this page explains the templates' code.
Here is a summary
of what both templates do:

<blockquote>
<pre>
public class <em>AnimatorClass</em> extends <em>AComponentClass</em> implements Runnable {

    <em>//In initialization code: 
        //From user-specified frames-per-second value, determine
	//how long to delay between frames.</em>

    <em>//In a method that does nothing but start the animation:</em>
        <em>//Create and start the animating thread.</em>

    <em>//In a method that does nothing but stop the animation:</em>
        <em>//Stop the animating thread.</em>

    public boolean mouseDown(Event e, int x, int y) {
        if (<em>/* animation is currently frozen */</em>) {
            <em>//Call the method that starts the animation.</em>
        } else {
            <em>//Call the method that stops the animation.</em>
        }
    }

    public void run() {
        <em>//Lower this thread's priority so it can't interfere
	//with other processing going on.</em>

        <em>//Remember the starting time.</em>

        //Here's the animation loop:
        while (<em>/* animation thread is still running */</em>) {
            <em>//Advance the animation frame.
            //Display it.
            //Delay depending on how far we are behind.</em>
        }
    }

    public void paint(Graphics g) {
        <em>//Draw the current frame of animation.</em>
    }
}
</pre>
</blockquote>

<h4>Initializing Instance Variables</h4>
<blockquote>
The animation templates use four instance variables.
The first instance variable (<code>frameNumber</code>)
represents the current frame. 
It's initialized to -1,
even though the first frame number is 0.
The reason: 
the frame number is incremented at the start of the animation loop,
before any frames are painted.
Thus, the first frame to be painted is frame 0.

<p>

The second instance variable (<code>delay</code>) 
is the number of milliseconds between frames.
It's initialized using a <em>frames per second</em> number
provided by the user.
If the user provides no valid number, 
then the templates default to 10 frames per second.
The following code converts frames per second
into the number of milliseconds between frames:
<blockquote>
<pre>
delay = (fps > 0) ? (1000 / fps) : 100;
</pre>
</blockquote>
<p>

The <code>?</code> <code>:</code> notation 
in the previous code snippet is shorthand
for <code>if</code> <code>else</code>.
If the user provides a number of frames per second greater than 0,
then the delay is 1000 milliseconds
divided by the number of frames per second.
Otherwise, the delay between frames is 100 milliseconds.

<p>

The third instance variable (<code>animatorThread</code>)
is a Thread object,
representing the thread
in which the animation loop runs.
If you're not familiar with threads,
see the
<a target="_top" href="http://docs.rinet.ru:8080/OLDui/essential/threads/index.html">Threads of Control</a><a href="http://docs.rinet.ru:8080/OLDui/essential/threads/index.html"><img src="http://docs.rinet.ru/OLDui/images/javaIcon.gif" width=20 height=20 border=0 alt="(in the Learning the Java Language trail)"></a> lesson for an overview of their use.

<p>

The fourth instance variable (<code>frozen</code>)
is a boolean value that's initialized to <code>false</code>.
The templates set it to <code>true</code> to indicate
that the user has requested that the animation stop.
You'll see more about this later in this section.


</blockquote>
<h4>The Animation Loop</h4>
<blockquote>
The animation loop 
(the <code>while</code> loop in the animation thread)
does the following, over and over again:
<ol>
<li> Advances the frame number.
<li> Calls the <code>repaint()</code> method to request
     that the current frame of animation be drawn.
<li> Sleeps for up to <code>delay</code> milliseconds
     (more on this later).
</ol>
<p>

Here's the code 
that performs these tasks:

<p>
<blockquote>
<pre>
while (<em>/* animation thread is still running */</em>) {
    //Advance the animation frame.
    frameNumber++;

    //Display it.
    repaint();

    <em>...//Delay depending on how far we are behind.</em>
}
</pre>
</blockquote>


</blockquote>
<h4>Ensuring a Constant Frame Rate</h4>
<blockquote>
The most obvious way to implement the sleep in the animation loop
is to sleep for <code>delay</code> milliseconds.
This can cause the thread to sleep too long, however,
since you lose a certain amount of time
just by executing the animation loop.

<p>

The solution to this problem is to remember when
the animation loop starts,
add <code>delay</code> milliseconds to arrive at a wakeup time,
and then sleep until the wakeup time.
Here's the code that implements this:
<blockquote>
<pre>
long startTime = System.currentTimeMillis();
while (<em>/* animation thread is still running */</em>) {
    <em>...//Advance the animation frame and display it.</em>
    try {
        startTime += delay;
        Thread.sleep(Math.max(0,
                              startTime-System.currentTimeMillis()));
    } catch (InterruptedException e) {
        break;
    }
}
</pre>
</blockquote>
</blockquote>


<h4>Behaving Politely</h4>
<blockquote>
Two more features of the animation templates
belong in the category of polite behavior.

<p>

The first feature is allowing the user to explicitly stop (and restart)
the animation, while the applet or application is still visible.
Animation can be quite distracting,
and it's a good idea to give the user the power to stop the animation
so that the user can concentrate on something else.
This feature is implemented by overriding the
<code>mouseDown()</code> method so that it
stops or starts the animation thread,
depending on the thread's current state.
Here's the code that implements this:

<blockquote>
<pre>
...<em>//In initialization code:</em>
boolean frozen = false;

...<em>//In the method that starts the animation thread:</em>
    if (frozen) {
        //Do nothing.  The user has requested that we
        //stop changing the image.
    } else {
        //Start animating!
       ...<em>//Create and start the animating thread.</em>
    }
}

. . .

public boolean mouseDown(Event e, int x, int y) {
    if (frozen) {
        frozen = false;
        <em>//Call the method that stops the animation.</em>
    } else {
        frozen = true;
        <em>//Call the method that stops the animation.</em>
    }
    return true;
}
</pre>
</blockquote>

<p>

The second feature is suspending the animation
whenever the applet or application is known
not to be visible.
For the applet animation template,
this is achieved by implementing the Applet
<code>stop()</code> and <code>start()</code> methods.
For the application animation template,
this is achieved 
by implementing an event handler for the WINDOW_ICONIFY
and WINDOW_DEICONIFY events.
In both templates,
if the user hasn't frozen the animation,
then when the program detects that the animation isn't visible,
it tells the animation thread to stop.
When the user revisits the animation,
the program restarts the animation thread,
unless the user has explicitly requested
that the animation be stopped.

<p>

You might be wondering why
the frame number is incremented at the beginning of the loop,
rather than at the end.
The reason has to do with what happens
when the user freezes the animation,
then leaves it, and then revisits it.
When the user freezes the animation, 
the animation loop completes before exiting.
If the frame number were incremented at the bottom of the loop,
instead of at the top of the loop,
then the frame number when the loop exits
would be one more than the number of the frame
that's being displayed.
When the user revisited the animation,
the animation would
be frozen on a different frame than the one the user left.
This could be disconcerting and,
if the user stopped the animation 
to look at a particular frame,
annoying.

</blockquote>
</blockquote>
<p>
<hr size=4>
<p> 
<table width="100%">
<tr>
<td align=left>
<a href="animation.html"><img src="http://docs.rinet.ru/OLDui/images/PreviousArrow.gif" width=26 height=26 align=top border=0 alt="Previous | "></a><a
href="animgraphics.html"><img src="http://docs.rinet.ru/OLDui/images/NextArrow.gif" width=26 height=26 align=top border=0 alt="Next | "></a><a
href="http://docs.rinet.ru:8080/OLDui/trailmap.html"><img src="http://docs.rinet.ru/OLDui/images/WayUpArrow.gif" width=26 height=26 align=top border=0 alt="Trail Map | "></a><a
href="..\index.html"><img src="http://docs.rinet.ru/OLDui/images/uiHeader.gif" width=26 height=26 align=top border=0 alt="Creating a User Interface (AWT Only) | "></a>
</td>
<td align=right>
<a href="index.html"><strong><em>Working with Graphics</em></strong></a>
</td>
</tr>
</table>
</body>
</html>
