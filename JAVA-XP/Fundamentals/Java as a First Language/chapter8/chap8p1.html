<html>

<head><meta http-equiv="pragma" content="no-cache">

<meta NAME="GENERATOR" CONTENT="Internet Assistant for Microsoft Word 2.0z">
<title>8.1 An initial concurrent example</title>

</head>

<body BGCOLOR="WHITE">

<h2>8.1 An initial concurrent example<br>
</h2>

<p>
To introduce the development of concurrent programs a simple example
involving a <i>RoomMonitor</i> will be developed. In the first
version of the program there will be a total of four threads.
The first thread is the main program thread whose task is to start
the other three threads. Two other threads are used to simulate
people entering the room and to simulate people leaving the room.
The final thread is used to occasionally show the status of the
<i>RoomMonitor</i>.  <br>

<p>
The program component which will be used to simulate the entry
of people into the room will be an instance of the <i>RoomFiller</i>
class whose class diagram is given in Figure 8.1.<br>

<p>
<center><img SRC="c8p1i1.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/c8p1i1.gif" WIDTH="398" HEIGHT="240"></center>
<p>
<center>Figure 8.1 <i>RoomFiller</i> class diagram.</center>
<p>
The class diagram indicates that the <i>RoomFiller</i> class is
an extension of the Java pre-declared <font FACE="Arial">Thread</font>
class. Most of the complexity of establishing and controlling
a thread is supplied by the <font FACE="Arial">Thread</font>
class and the minimum that needs to be done is to override its
<i>run</i>() action. The <i>RoomFiller</i> constructor requires
a <i>RoomMonitor</i> as an argument in order for it to know which
room people are to be admitted into. The implementation of this
design, as far as the end of the constructor, is as follows. 
<br>

<pre>
<font>0001 // Filename <i>RoomFiller.java</i>.
0002 // Providing a thread to admit people into the room.
0003 //
0004 // Written for JFL book Chapter 8 see text.
0005 // Fintan Culwin, v0.1, January 1997.
0006 
0007 <b>import</b> <i>Counters.RoomMonitor</i>;
0008 <b>import</b> java.util.Random;
0009 
0010 <b>public class</b> <i>RoomFiller</i> <b>extends</b> Thread { 
0011 
0012 <i>RoomMonitor  roomToFill</i>;
0013 Random       <i>generator</i> = <b>new</b> Random();
0014 
0015    <b>public</b> <i>RoomFiller</i>( <i>RoomMonitor aRoomMonitor</i>) { 
0016       <i>roomToFill</i> = <i>aRoomMonitor;
</i>0017    } // End <i>RoomFiller</i> Constructor.
0018 <br>
</font>
</pre>

<p>
The context clause of this class imports the <i><font FACE="Arial">Counters.RoomMonitor</font></i>
class and the <i><font FACE="Arial">java.util.Random</font></i>
standard class. This latter class supplies a random number generator
which is used to introduce a small degree of unpredictability
into <i><font FACE="Arial">RoomFiller</font></i>'s behaviour.
A partial class diagram of the <i><font FACE="Arial">java.util.Random</font></i>
class is given in Figure 8.2.<br>

<p>
<center><img SRC="c8p1i2.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/c8p1i2.gif" WIDTH="402" HEIGHT="272"></center>
<center><font>Figure 8.2 Partial <i>java.util.Random</i>
class diagram.<br>
</font></center>
<p>
The <font FACE="Arial">nextDouble</font>() action will
supply a random double value in the range 0.0 to 1.0 each time
it is called. The <font FACE="Arial">nextInt()</font> action
will supply a random integer value between the lowest and highest
integer value. An instance of the <font FACE="Arial">Random</font>
class called <i><font FACE="Arial">generator</font></i>
is constructed on line 0013.<br>

<p>
The <i><font FACE="Arial">RoomFiller</font></i> constructor
does not construct its own <i><font FACE="Arial">RoomMonitor</font></i>
 instance but requires an already constructed <i><font FACE="Arial">RoomMonitor</font></i>
instance to be supplied as a <i><font FACE="Arial">RoomFiller</font></i>
is constructed. The <i><font FACE="Arial">RoomFiller</font></i>
constructor is implemented by storing the identity of the <i><font FACE="Arial">RoomMonitor</font></i>
passed as an argument, in the instance attribute called <i><font FACE="Arial">roomToFill</font></i>.
The design of the<i><font FACE="Arial"> run</font></i>()
action is as follows. <br>

<p>
<center><img SRC="c8p1i3.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/c8p1i3.gif" WIDTH="704" HEIGHT="441">
</center>
<p>
The basis of the design is to iterate forever and on each iteration
to pause for a random amount of time before admitting a person
into the room and confirming this on the terminal screen. In order
to implement the <i>pause</i> part of the design the thread has
to be put to sleep, and this can only be done with a posit/&nbsp;admit
structure which guards against the sleep being interrupted. The
implementation of this design is as follows. <br>

<pre>
<font>0019    <b>public void</b> <i>run</i>() {
0020    
0021    <b>int</b> <i>delay</i>;
0022    
0023        <b>while</b> ( <b>true</b>) { 
0024           <b>try</b> {
0025              <i>delay</i> = (<b>int</b>) ( <i>generator</i>.nextDouble() * 200.0);
0026              <b>this</b>.sleep( <i>delay</i>);
0027           } <b>catch</b> ( InterruptedException <i>exception</i> ){ 
0028             // Do nothing.
0029           } // End try/catch.
0030           <i>roomToFill.enterRoom</i>();
0031           System.out.println( &quot;Entered ...&quot;);
0032        } // End while.
0033    } // End run.
0034 
0035 } // End <i>RoomFiller.<br>
</i></font>
</pre>

<p>
On line 0023 the loop condition is expressed as the <b><font FACE="Arial">boolean</font></b>
value <b><font FACE="Arial">true</font></b>, which can
never be interpreted as <b><font FACE="Arial">false</font></b>
and so the loop will iterate forever. In accord with the design
the body of the iteration starts with a <b><font FACE="Arial">try</font></b>/&nbsp;<b><font FACE="Arial">catch</font></b>
structure. Within the <b><font FACE="Arial">try</font></b>
part of the structure the value of the local <b><font FACE="Arial">int</font></b>eger
variable <i><font FACE="Arial">delay</font></i> is given
a value between 0 and 200. This is accomplished by obtaining a
double value from the random number <i><font FACE="Arial">generator</font></i>
which will be between 0.0 and 1.0. This value is multiplied by
200.0 to produce a value between 0.0 and 200.0 which is subsequently
cast to an <b><font FACE="Arial">int</font></b>eger between
0 and 200.<br>

<p>
On line 0026 the <font FACE="Arial">sleep</font>() action
of the <i><font FACE="Arial">RoomFiller</font></i> instance,
which is inherited from the <font FACE="Arial">Thread</font>
class, is called to suspend the thread for a delay specified by
its argument. The value of the argument indicates the number of
milliseconds which the thread should be suspended for. It is possible
for the suspension to be interrupted and this has to be handled
in the <b><font FACE="Arial">catch</font></b> part of the
<b><font FACE="Arial">try/&nbsp;catch</font></b> structure
on lines 0027 to 0028. In this case no action needs to be taken
and so the <b><font FACE="Arial">catch</font></b> is empty.
The overall effect of the <b><font FACE="Arial">try/&nbsp;catch</font></b>
structure is to delay the thread for between 0.0 and 0.2 seconds.
The necessity for enclosing a <font FACE="Arial">sleep</font>()
call within a <b><font FACE="Arial">try/ catch</font></b>
structure will be explained in Chapter 9.<br>

<p>
Following the pause a person is admitted to the room by calling
the <i><font FACE="Arial">enterRoom</font></i>() action
of the <i><font FACE="Arial">roomToFill</font></i> <i><font FACE="Arial">RoomMonitor</font></i>
instance which was supplied when the <i><font FACE="Arial">RoomFiller</font></i>
instance was constructed. Once a person has been admitted into
the room an output is sent to the screen to indicate to the user
that it has happened. <br>

<p>
The second thread is responsible for removing people from the
room and is implemented as an instance of the <i><font FACE="Arial">RoomEmptyer</font></i>
class whose class diagram does not differ significantly from that
presented in Figure 8.2 for the <i><font FACE="Arial">RoomFiller</font></i>
class. The implementation of this class is as follows. <br>

<pre>
<font>0001 // Filename <i>RoomEmptyer.java</i>.
0002 // Providing a thread to remove people from a room.
0003 //
0004 // Written for JFL book Chapter 8 see text.
0005 // Fintan Culwin, v0.1, January 1997.
0006 
0007 <b>import</b> <i>Counters.RoomMonitor</i>;
0008 <b>import</b> java.util.Random;
0009 
0010 <b>public class</b> <i>RoomEmptyer</i> <b>extends</b> Thread { 
0011 
0012 <i>RoomMonitor  roomToEmpty</i>;
0013 Random       <i>generator</i> = <b>new</b> Random();
0014 
0015    <b>public</b> <i>RoomEmptyer</i>( <i>RoomMonitor theMonitor</i>) { 
0016       <i>roomToEmpty</i> = <i>theMonitor</i>; 
0017    } // End <i>RoomFiller</i> Constructor;
0018 
0019    <b>public void</b> <i>run</i>() {
0020    
0021    <b>int</b>    <i>delay</i>;
0022    <b>double</b> <i>leaveRoom</i>; 
0023    
0024 
0025        <b>while</b> ( <b>true</b>) { 
0026           <b>try</b> {
0027              <i>delay</i> = (<b>int</b>) (<i>generator</i>.nextDouble() * 200.0);
0028              <b>this</b>.sleep( <i>delay</i>);
0029           } <b>catch</b> ( InterruptedException <i>exception</i> ){ 
0030             // Do nothing.
0031           } // End try/ catch
0032           <i>leaveRoom</i> = <i>generator</i>.nextDouble() * 
0033                        (<b>double</b>) <i>roomToEmpty.numberCurrentlyInRoomIs</i>(); 
0034           <b>if</b> ( <i>leaveRoom</i> &gt; 0.33) { 
0035              <i>roomToEmpty.exitRoom</i>();
0036              System.out.println( &quot;Exited ...&quot;);
0037           } // End if.
0038        } // End while.
0039    } // End <i>run</i>.
0040 
0041 } // End <i>RoomEmptyer</i>.<br>
</font>
</pre>

<p>
The only significant difference in this class is that after the
pause in the <i>run</i>() action the decision on leaving the room
is based upon the generation of a second random number which is
multiplied by the number of people currently in the room. Thus
the chance of a person leaving the room on each iteration increases
as the number of people in the room increases. This is in accord
with a consideration of what would happen in the real world.<br>

<p>
The third thread is responsible for reporting on the status of
the room and is provided as an instance of the <i><font FACE="Arial">RoomReporter</font></i>
class whose object diagram and construction does not differ significantly
from the previous two classes. The <b><font FACE="Arial">while</font></b>
loop of the <font FACE="Arial">run</font>() action of this
class is as follows. <br>

<pre>
<font>0023        <b>while</b> ( <b>true</b>)  { 
0024           <b>try</b> {
0025              <b>this</b>.sleep( 2000);
0026           } <b>catch</b> ( InterruptedException <i>exception</i> ){ 
0027             // Do nothing.
0028           } // End try/ catch
0029           System.out.println( <i>roomToReportOn</i>);
0030        } // End while.<br>
</font>
</pre>

<p>
This indicates that the state of the room will be reported upon
approximately every two seconds. The demonstration client for
this example, called <i>ThreadDemo</i>, has the following design.
<br>

<p>
<center><img SRC="c8p1i4.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/c8p1i4.gif" WIDTH="506" HEIGHT="164">
</center>
<p>
The significant difference in this design is the use of a double
horizontal line to connect two or more components, which indicates
that the components will execute concurrently. The implementation
of this design is as follows. <br>

<pre>
<font>0001 // Filename <i>ThreadDemo.java</i>.
0002 // Implements a concurrent process involving three subservient
0003 // threads.
0004 //
0005 // Written for JFL book Chapter 6 see text.
0006 // Fintan Culwin, v0.1, January 1997
0007 
0008 <b>import</b> <i>Counters.RoomMonitor</i>;
0009 
0010 <b>public class</b> <i>ThreadDemo</i> { 
0011 
0012    <b>public static void</b> <i>main</i>( String <i>argv</i>[]) { 
0013    
0014    <i>RoomMonitor  aMonitor</i>  = <b>new</b> <i>RoomMonitor</i>();
0015    <i>RoomFiller   aFiller</i>   = <b>new</b> <i>RoomFiller</i>(    <i>aMonitor</i>);
0016    <i>RoomEmptyer  anEmptyer</i> = <b>new</b> <i>RoomEmptyer</i>(   <i>aMonitor</i>);
0017    <i>RoomReporter aReporter</i> = <b>new</b> <i>RoomReporter</i>(  <i>aMonitor</i>);
0018 
0019        <i>aFiller</i>.start();
0020        <i>anEmptyer</i>.start();
0021        <i>aReporter</i>.start();
0022    } // End main. 
0023   
0024 } // End  ThreadDemo.<br>
</font>
</pre>

<p>
Within the <i><font FACE="Arial">main</font></i>() action
an instance of the <i><font FACE="Arial">RoomMonitor</font></i>
class is constructed and consequently used as the argument of
the <i><font FACE="Arial">RoomFiller</font></i>, <i><font FACE="Arial">RoomEmptyer</font></i>
and <i><font FACE="Arial">RoomReporter</font></i> constructors.
This causes each thread to be using the same <i><font FACE="Arial">RoomMonitor</font></i>
instance. Once all three thread objects have been constructed
the <font FACE="Arial">start</font>() action of each of
them is called. The <font FACE="Arial">start</font>() action
is supplied by the <font FACE="Arial">Thread</font> class
and inherited by each of the specialised classes implemented above.
The effect of calling the <font FACE="Arial">start</font>()
action is for Java to arrange for the <i><font FACE="Arial">run</font></i>()
action of the instance being <font FACE="Arial">start</font>ed
to be executed in a concurrent manner. The first part of the output
produced by this client when it was executed is as follows. <br>

<hr>

<ul><pre>
Entered ...
Exited ...
Entered ...
Exited ...
Entered ...
Entered ...
Exited ...
Entered ...
Entered ...
Entered ...
Entered ...
Entered ...
Exited ...
Entered ...
Exited ...
Exited ...
Entered ...
Entered ...
Exited ...
Entered ...
Exited ...
Entered ...
Now in room : 6 Max in room : 6 Total entered : 14</font>
</pre></ul>

<hr>

<p>
As the program has no way of stopping itself it had to be stopped
by interrupting it from the keyboard. The precise patterns of
entering and exiting and the output of the state of the monitor
cannot be precisely predicted from a consideration of the code.
Running the program for a second, or subsequent, time will produce
a different pattern of events. <br>

<p>
What is happening is that Java is dividing its time between all
three active threads, the fourth thread concerned with the <i><font FACE="Arial">main</font></i>()
action having finished. It will allocate an amount of time, known
as a <i><b>time&nbsp;slice</b></i>, to each thread and suspend
it once its slice has expired. Flow of control will then be passed
to one of the other threads and returned to the suspended thread
in due course, allowing it to continue for another time slice.
<br>

<p>
<hr>
<h2>
<ul>
<a HREF="roomfiller.java" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/RoomFiller.java"><img SRC="..\list.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/list.gif" ALIGN="MIDDLE" BORDER="0" WIDTH="40" HEIGHT="35">
<i>RoomFiller.java</i> source code</a>.
<p>
<a HREF="roomemptyer.java" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/RoomEmptyer.java"><img SRC="..\list.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/list.gif" ALIGN="MIDDLE" BORDER="0" WIDTH="40" HEIGHT="35">
<i>RoomEmptyer.java</i> source code</a>.
<p>
<a HREF="roomreporter.java" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/RoomReporter.java"><img SRC="..\list.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/list.gif" ALIGN="MIDDLE" BORDER="0" WIDTH="40" HEIGHT="35">
<i>RoomReporter.java</i> source code</a>.
<p><a HREF="threaddemo.java" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/ThreadDemo.java"><img SRC="..\list.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/list.gif" ALIGN="MIDDLE" BORDER="0" WIDTH="40" HEIGHT="35">
<i>ThreadDemo.java</i> source code</a>.
<p>
<a HREF="chap8p2.html" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/chap8p2.html"><img SRC="..\next.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/next.gif" ALIGN="MIDDLE" BORDER="0" WIDTH="50" HEIGHT="40">
8.2 Synchronisation of data attributes</a>.
<p>
<a HREF="chap8.html" tppabs="http://www.scism.sbu.ac.uk/jfl/Chapter8/chap8.html"><img SRC="..\last.gif" tppabs="http://www.scism.sbu.ac.uk/jfl/last.gif" ALIGN="MIDDLE" BORDER="0" WIDTH="50" HEIGHT="40">
Chapter 8 Concurrent processes</a>.
</ul>
</h2>
<hr>


</body>

</html>
&#26;