<HTML>
<HEAD>


<TITLE>Industrial Strength Java:Interfacing C/C++ and Java:EarthWeb Inc.-</TITLE>





<P><CENTER>
<a href="0605-0609.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0614-0618.html">Next</A>
</CENTER></P>

<A NAME="PAGENUM-610"><P>Page 610</P></A>



<P>Listing 14.8b TestObject Class: The testStatic() Method</P>

<PRE>
    static int testStatic(){
        return(++testStaticInt);
    }
</PRE>

<P>The class constructor for the TestObject class is shown in listing 14.8c. The
constructor has a parameter for each of the standard types and one of String class. These
parameters are printed to the standard output so that the creation of an object can be verified.
</P>

<P>Listing 14.8c TestObject class: The Class Constructor
</P>
<PRE>
    TestObject(boolean tBoolean,byte tByte,short tShort, int tInt,
        &Acirc;long tLong,float tFloat,double tDouble,char tChar,String tString){
        testObjectField= 100;
        testStatic();
        System.out.println(&quot;TestObject()&quot;);
        System.out.println(&quot;tBoolean:  &quot; + tBoolean);
        System.out.println(&quot;tByte:     &quot; + tByte);
        System.out.println(&quot;tShort:    &quot; + tShort);
        System.out.println(&quot;tInt:      &quot; + tInt);
        System.out.println(&quot;tLong:     &quot; + tLong);
        System.out.println(&quot;tFloat:    &quot; + tFloat);
        System.out.println(&quot;tDouble:   &quot; + tDouble);
        System.out.println(&quot;tChar:     &quot; + tChar);
        System.out.println(&quot;tString:   &quot; + tString);
        System.out.println(&quot;&quot;);
    }
</PRE>

<P>The next method in the TestObject class, testArrays(), shown in listing 14.8d, is used
to validate that native C can call a method in an object it has created. Arrays in
testArrays() are passed as parameters. Like the parameters in the constructor, the
parameters are printed to validate that the method was called correctly.
</P>

<P>Listing 14.8d TestObject class: The testArray() Method
</P>
<PRE>
void testArrays(boolean tBooleans[],byte tBytes[],short tShorts[], int
&Acirc;tInts[],long tLongs[],float tFloats[],double tDoubles[],char
&Acirc;tChars[],String tStrings[]){
        System.out.println(&quot;testArrays()&quot;);/*
</PRE>

<A NAME="PAGENUM-611"><P>Page 611</P></A>


<PRE>
        System.out.println(&quot;tBooleans[]:  &quot; + tBooleans);
        System.out.println(&quot;tBytes[]:     &quot; + tBytes);
        System.out.println(&quot;tShorts[]:    &quot; + tShorts);
        System.out.println(&quot;tInts[]:      &quot; + tInts);
        System.out.println(&quot;tLongs[]:     &quot; + tLongs);
        System.out.println(&quot;tFloats[]:    &quot; + tFloats);
        System.out.println(&quot;tDoubles[]:   &quot; + tDoubles);
        System.out.println(&quot;tChars[]:     &quot; + tChars);
        System.out.println(&quot;tStrings[]:   &quot; + tStrings);*/
        System.out.println(&quot;&quot;);
    }//End of testArrays() method
}// End of TestObject class
</PRE>

<H3><A NAME="ch14_ 14">
javah: The Header and Stub <BR>
Generator
</A></H3>

<P>The javah utility is used to generate header files and stub files are used by native
programs to interface to Java. The javah utility must be run twice for each Java class that accesses
or contains native methods, first to create C header files and then with the &quot;-stubs&quot;
parameter to create a stub file. In each example in this chapter, a BAT file is used to call javah
for each native class. The batch file also copies the header and C files to their proper
C development directories. A shell or BAT file should be used in this way because batch
files automate the process, thus reducing errors. Listing 14.9 is the do_javah.bat file for
the examples discussed so far.
</P>

<P>Listing 14.9 do_java.bat file: Used to Generate Header and Stub Files for
the Native Method Test
</P>
<PRE>
javah -classpath %CLASSPATH% -v NativeTest
javah -classpath %CLASSPATH% -v -stubs NativeTest
javah -classpath %CLASSPATH% -v TestObject
javah -classpath %CLASSPATH% -v -stubs TestObject
move *.c NativeTestDLL
move *.h NativeTestDLL
</PRE>

<A NAME="PAGENUM-612"><P>Page 612</P></A>



<H4><A NAME="ch14_ 15">
Files Generated by javah
</A></H4>

<P>The files output by javah have a wealth of information about how C can access Java.
The first file to be examined is the header file for the TestObject class.
</P>

<B>
Header Files Generated by javah
</B>

<P>The TestObject class does not define any native methods, but it does define two
fields, testStaticInt and testObjectField. The Note javah has made is a comment that
testStaticInt is a static variable and is not accessible. Static variables cannot be accessed directly,
but they can be accessed via class methods. The reason
static variables cannot be accessed is that static variables cannot be made a part of
C structures (remember the native API is for C, not C++; C++ can have statics in classes, not C). The structure for the class
only represents fields that are part of objects. The second field, testObjectField, in which
Java was declared as an int, here is declared long. After an object has been created of this
class, this field is available for access by C.
</P>

<P>The most striking attribute of this header is that it does not contain any references to
the methods in the TestObject class because all method calls are done by name, as is
covered later (see listing 14.10).
</P>

<P>Listing 14.10 javah Output: The C Header File for TestObject Class
</P>
<PRE>
/* DO NOT EDIT THIS FILE - it is machine generated */
#include &lt;native.h&gt;
/* Header for class TestObject */
#ifndef _Included_TestObject
#define _Included_TestObject
typedef struct ClassTestObject {
/* Inaccessible static: testStaticInt */
    long testObjectField;
} ClassTestObject;
HandleTo(TestObject);
#ifdef __cplusplus
extern &quot;C&quot; {
#endif
#ifdef __cplusplus
}
#endif
#endif
</PRE>

<P>The header file produced by javah for the TestObject class has a lot more information.
It contains a structure that represents the accessible data in the object, which for
TestObject
</P>

<A NAME="PAGENUM-613"><P>Page 613</P></A>


<P>is myErrorValue. Following the structure definition are external definitions for each of
the C methods that are to be called from the stubs file. Use these definitions to create your
C functions, as shown in listing 14.11.
</P>

<P>The first parameter of each of these methods is
&quot;struct HNativeTest *&quot;, which is the equivalent of the &quot;this&quot; pointer to the object.
</P>

<P>An important observation to make of the methods that deal with
arrays is that arrays are converted to object handles. An array of int, for example, is converted to
HArrayOfInt because arrays are objects in Java.
</P>

<P>Listing 14.11 javah Output: The C Header File for TestObject Class
</P>
<PRE>
/* DO NOT EDIT THIS FILE - it is machine generated */
#include &lt;native.h&gt;
/* Header for class NativeTest */
#ifndef _Included_NativeTest
#define _Included_NativeTest
typedef struct ClassNativeTest {
    long myErrorValue;
} ClassNativeTest;
HandleTo(NativeTest);
#ifdef __cplusplus
extern &quot;C&quot; {
#endif
extern long NativeTest_nativeInt(struct HNativeTest *,long);
extern unicode NativeTest_nativeChar(struct HNativeTest *,unicode);
extern short NativeTest_nativeShort(struct HNativeTest *,short);
extern float NativeTest_nativeFloat(struct HNativeTest *,float);
extern double NativeTest_nativeDouble(struct HNativeTest *,double);
extern /*boolean*/ long NativeTest_nativeBoolean(struct HNativeTest *,/
&Acirc;*boolean*/ long);
extern HArrayOfInt *NativeTest_nativeIntArray(struct HNativeTest
&Acirc;*,HArrayOfInt *);
extern HArrayOfChar *NativeTest_nativeCharArray(struct HNativeTest
&Acirc;*,HArrayOfChar *);
extern HArrayOfShort *NativeTest_nativeShortArray(struct HNativeTest
&Acirc;*,HArrayOfShort *);
extern HArrayOfFloat *NativeTest_nativeFloatArray(struct HNativeTest
&Acirc;*,HArrayOfFloat *);
extern HArrayOfDouble *NativeTest_nativeDoubleArray(struct HNativeTest
&Acirc;*,HArrayOfDouble *);
extern /*boolean*/ HArrayOfInt *NativeTest_nativeBooleanArray(struct
&Acirc;HNativeTest *,HArrayOfInt *);
</PRE>
<PRE>
                                                                          continues
</PRE>

<P><CENTER>
<a href="0605-0609.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0614-0618.html">Next</A>
</CENTER></P>






</BODY>
</HTML>



