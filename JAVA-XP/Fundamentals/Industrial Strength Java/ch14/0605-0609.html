<HTML>
<HEAD>


<TITLE>Industrial Strength Java:Interfacing C/C++ and Java:EarthWeb Inc.-</TITLE>





<P><CENTER>
<a href="0600-0604.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0610-0613.html">Next</A>
</CENTER></P>

<A NAME="PAGENUM-605"><P>Page 605</P></A>


<PRE>
        char inputCharArray[] = new char[arraySize];
        for (int i = 0; i &lt; inputIntArray.length; i++){
            inputCharArray[i] = 1;
        }
        char[] outputCharArray = nativeCharArray(inputCharArray);
        for (int i = 0; i &lt; inputIntArray.length; i++){
            if (inputCharArray[i] != outputCharArray[i]) return(false);
        }
        // Test short array
        short inputShortArray[] = new short[arraySize];
        for (int i = 0; i &lt; inputShortArray.length; i++){
            inputShortArray[i] = 1;
        }
        short[] outputShortArray = nativeShortArray(inputShortArray);
        for (int i = 0; i &lt; inputShortArray.length; i++){
            if(inputShortArray[i] != outputShortArray[i]) return(false);
        }
        // Test float array
        float inputFloatArray[] = new float[arraySize];
        for (int i = 0; i &lt; inputFloatArray.length; i++){
            inputFloatArray[i] = 1;
        }
        float[] outputFloatArray = nativeFloatArray(inputFloatArray);
        // Test double array
        double inputDoubleArray[] = new double[arraySize];
        for (int i = 0; i &lt; inputIntArray.length; i++){
            inputDoubleArray[i] = 1;
        }
        double[] outputDoubleArray =
                 &Acirc;nativeDoubleArray(inputDoubleArray);
        for (int i = 0; i &lt; inputIntArray.length; i++){
            if (inputDoubleArray[i] != outputDoubleArray[i])
                          &Acirc;return(false);
        }
        // Test boolean array
        boolean inputBooleanArray[] = new boolean[arraySize];
        for (int i = 0; i &lt; inputIntArray.length; i++){
            inputBooleanArray[i] = true;
        }
        boolean[] outputBooleanArray =
                 &Acirc;nativeBooleanArray(inputBooleanArray);
        for (int i = 0; i &lt; inputIntArray.length; i++){
            if (inputBooleanArray[i] != outputBooleanArray[i])
                         &Acirc;return(false);
        }
</PRE>
<PRE>
                                                                                 continues
</PRE>

<A NAME="PAGENUM-606"><P>Page 606</P></A>



<P>Listing 14.7b Continued
</P>
<PRE>
        // Object passing (casting for clarity).
        TestObject inputObject = new TestObject( true
            ,(byte)1
            ,(short)1
            ,(int)1
            ,(long)1
            ,(float)1.0
            ,(double)1.0
            ,(char)'1'
            ,(String)&quot;One&quot;);
        TestObject outputObject = nativeObject(inputObject);
        // Arrays of Objects passing
        TestObject inputObjectArray[] = new TestObject[arraySize];
        for (int i = 0; i &lt; inputObjectArray.length; i++){
            inputObjectArray[i] = new
            TestObject(true,(byte)1,(short)1,(int)1,(long)1,(float)1.0,
                          &Acirc;(double)1.0,(char)'1',(String)&quot;One&quot;);;
            }
        TestObject[] outputObjectArray =
                  &Acirc;nativeObjectArray(inputObjectArray);
        //for (int i = 0; i &lt; inputObjectArray.length; i++){
        //if(!inputObjectArray[i].isEqual(outputObjectArray[i]))
        //return(false);}
        callJava();
        testException3();
        testExceptions(1);
        testExceptions(2);
        // if we got here then it all worked!
        return true;
    }
</PRE>

<P>The next section of code simply declares native methods of the TestObject class.
</P>

<P>Listing 14.7c Simple Native Method Declarations
</P>
<PRE>
    // ----------
    // Dealing with atoms
    // ----------
    native int nativeInt(int anInt);
    native char nativeChar(char aChar);
    native short nativeShort(short aShort);
    native float nativeFloat(float aFloat);
</PRE>

<A NAME="PAGENUM-607"><P>Page 607</P></A>


<PRE>
    native double nativeDouble(double aDouble);
    native boolean nativeBoolean(boolean aBoolean);
    // ----------
    // Dealing with arrays
    // ----------
    native int[] nativeIntArray(int anInt[]);
    native char[] nativeCharArray(char aChar[]);
    native short[] nativeShortArray(short aShort[]);
    native float[] nativeFloatArray(float aFloat[]);
    native double[] nativeDoubleArray(double aDouble[]);
    native boolean[] nativeBooleanArray(boolean aBoolean[]);
</PRE>

<P>Listing 14.7d defines native methods used to pass Objects and Object arrays between
Java and C code.
</P>

<P>Listing 14.7d Native Methods Used to Pass Objects and Object Arrays
</P>
<PRE>

    // ----------
    // Objective passing
    // ----------
    native TestObject nativeObject(TestObject anObject);
    native TestObject[] nativeObjectArray(TestObject anObject[]);
</PRE>

<P>Listing 14.7e Native Method that Will Call Java from C
</P>
<PRE>
    // ----------
    // Calling Java from C
    // ----------
    native void callJava();
</PRE>

<P>Listing 14.7f Native Method that Generate Exceptions when Called
</P>
<PRE>
// ----------
    // Generating exceptions
    // ----------
    native void doExceptions(int type) throws java.io.IOException,
        &Acirc;ArithmeticException ;
</PRE>

<P>Listing 14.7g shows the method used to call the functions in listing 14.7f.
</P>

<A NAME="PAGENUM-608"><P>Page 608</P></A>


<P>Listing 14.7g Java Method Used to Call Native Functions that <BR>
Throw Exceptions
</P>

<PRE>
void testExceptions(int type){
        try{
            doExceptions(type);
        }
        catch (java.io.IOException ioe){
            System.out.println(&quot;Native code generated a
                         &Acirc;java.io.IOException.&quot;);
            System.out.println();
        }
        catch (ArithmeticException ae){
            System.out.println(&quot;Native code generated an
                          &Acirc;ArithmeticException.&quot;);
            System.out.println();
        }
    }
</PRE>

<P>The next section of this class defines a field used by the native testException2() method <BR>
to pass information just before an exception is thrown. The last method of this
class, testException3(), calls testException2, which sets the myErrorValue field and then
throws an IOException. This example is provided because the native interface is unable
to generate an exception other than IOException. By passing information in special
class fields, the equivalent functionality can be simulated. Use this pattern of setting
exception information fields and then throwing the IOException any time where a
specialized exception would be required. For instance, if native code were controlling a serial port,
the data returned in a specialized variable might be an I/O error number. For the
implementation of the testException2() method, refer to listing 14.7h.
</P>

<P>Listing 14.7h TestObject Class: A Native Method that Throws an Exception
and Passes Data
</P>
<PRE>
    // Getting error data from exceptions
    /**
     * Field used to pass error data.
     */
    int myErrorValue;
    /**
     * Always generates an IOException.
     * Modifies the value of myErrorValue
     * to designate errorinformation.
</PRE>

<A NAME="PAGENUM-609"><P>Page 609</P></A>


<PRE>
     */
    native void testException2() throws java.io.IOException;
    /**
     * Tests that data can be pased and used after
     * an exception is thrown.
     */
    void testException3(){
        try{
            // clear the error value
            myErrorValue = 0;
              //call native.
              testException2();
        }catch(java.io.IOException ioe){
                   System.out.println(&quot;exception
                                        &Acirc;information:&quot;+myErrorValue);
        }
    }
} //End of class TestObject
</PRE>
<P>
<B>
Accessing Classes and Objects from C: TestObject.Java
</B>
</P>

<P>The next class in the example is used to demonstrate several more capabilities of
the native API. The TestObject.Java class helps to exercise access from C to Java methods
and to access or create user defined objects. This class contains no native methods.
Native code in the testStatic() method directly accesses the static class field. It will be
necessary to run javah on this class so that the method structure can be imported to C code.
</P>

<P>The TestObject class in listing 14.1a begins with two fields. The first field, testStaticInt,
is to be accessed by native C from the class reference. The next is an object variable that
will also be accessed, but after an object is created. Refer to listing 14.8a to see the C code
that accesses these fields.
</P>

<P>Listing 14.8a TestObject Class: Variables
</P>
<PRE>
public class TestObject{
    static int testStaticInt = 0;
    int testObjectField;
</PRE>

<P>The static method of listing 14.8b is called to prove that static methods can be
accessed through a class reference.
</P>

<P><CENTER>
<a href="0600-0604.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0610-0613.html">Next</A>
</CENTER></P>






</BODY>
</HTML>



