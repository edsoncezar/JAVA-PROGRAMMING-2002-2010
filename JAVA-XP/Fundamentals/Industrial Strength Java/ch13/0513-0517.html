<HTML>

<HEAD>



<TITLE>Industrial Strength Java:Thinking in Terms of Threads:EarthWeb Inc.-</TITLE>



















<P><CENTER>

<a href="0508-0512.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0518-0521.html">Next</A>

</CENTER></P>



<A NAME="PAGENUM-513"><P>Page 513</P></A>






<PRE>

//constructor

public FileChecksum(File f)

        throws FileNotFoundException {

        //get the length of the file

        length = f.length();



        //initialize the sum to 0

        sum = 0;



        //clear the finished flag

        finished = false;



        //Open a FileInputStream for this file

        fis = new FileInputStream(f);



        //Create a Thread object that will run our

        //processing for us.  Pass the filename as

        //the name of the Thread.  Pass this as the

        //object to be run by the new Thread.

        thread = new Thread(this, f.getName());



        //Start the new thread running.

        thread.start();



} //end of constructor



//The run() method that the Runnable interfaces requires

//us to declare.  This is the method that the new thread

//of control will call.

public void run() {

        //Loop through all of the bytes in the file

        //and generate a checksum.

        try {

                for(int i=0; i&lt;length; i++)

                        sum += (long)fis.read();

        }



        catch(IOException e) { }



        finally {

                finished = true;

                try {

                        fis.close();

                }

                catch(IOException e) { }

</PRE>


<PRE>
continues
</PRE>




<A NAME="PAGENUM-514"><P>Page 514</P></A>







<P>Listing 13.8 Continued </P>


<PRE>

        }



        //Leaving the run() method will stop the

        //thread.

}



//object methods



//getChecksum will return -1 if we haven't finished

//calculating the checksum yet.

public long getChecksum() {

        if(finished)

                return sum;

        else

                return -1;

}

}       //end of FileChecksum

</PRE>




<P>In the new FileChecksum constructor, this is passed as the Runnable. When the

new thread is started by calling the start() method of the new Thread object, the

following occurs:

</P>



<OL>

<LI>          The new thread of control enters the run() method of the Runnable supplied,

the FileChecksum object itself.

<LI>     When the run() method exits, the thread of control finishes and dies.

The FileChecksum object is unaffected by this.

</OL>



<P>A thread finishes when run() returns just like a Java program finishes when the

initial thread returns from main().

</P>



<B>

Providing a run() Method to a Thread

</B>



<P>There are two ways of associating a run() method with a Thread object:

</P>



<UL>

<LI>          By passing a Runnable to the Thread constructor

<LI>          By subclassing Thread and providing a run() method in the new class (because

the Thread class implements Runnable).

</UL>



<P>The default Thread.run() method does nothing, so it must be overridden to do any

useful work. Listing 13.9 shows how FileChecksum might be implemented as a subclass

of Thread:

</P>



<A NAME="PAGENUM-515"><P>Page 515</P></A>



<P>Listing 13.9 The Threaded FileChecksum Class as a Subclass of Thread

</P>




<PRE>

import java.io.*;



//File checksum object which uses a Thread to calculate the

//checksum in parallel with other processing.

public class FileChecksumThread extends Thread {



//object variables

private long                length;        //of the File

private long                sum;



private boolean             finished;

private FileInputStream     fis;



//constructor

public FileChecksumThread(File f)

        throws FileNotFoundException {



        //Call a Thread constructor with the name of the

        //file as the Thread name.

        super(f.getName());



        //get the length of the file

        length = f.length();



        //initialize the sum to 0

        sum = 0;



        //clear the finished flag

        finished = false;



        //Open a FileInputStream for this file

        fis = new FileInputStream(f);



        //Start the thread going.

        this.start();



} //end of constructor



//This run() method overrides the one in Thread.

public void run() {



        //Loop through all of the bytes in the file

        //and generate a checksum.

        try {

</PRE>


<PRE>
continues
</PRE>




<A NAME="PAGENUM-516"><P>Page 516</P></A>



<P>Listing 13.9 Continued

</P>


<PRE>

                for(int i=0; i&lt;length; i++)

                        sum += (long)fis.read();

        }



        catch(IOException e) { }



        finally {

                finished = true;

                try {

                        fis.close();

                }

                catch(IOException e) { }

        }

}



//object methods



//getChecksum will return -1 if we haven't finished

//calculating the checksum yet.

public long getChecksum() {

        if(finished)

                return sum;

        else

                return -1;

}

}       //end of FileChecksum

</PRE>




<P>After a thread has been created, the start() method must be called

to start the separate thread of control. After start() returns, assume

that the new Thread executes in parallel with all other threads in

the system. Exactly when the various threads in the system execute

is determined by the Java VM scheduler, which is discussed later

in the section about Thread Scheduling.

</P>



<B>

Getting a Result from FileChecksum

</B>



<P>A good design goal is to ensure that any code that previously

used the FileChecksum class should be able to use the new version

with minimal changes. However, consider the following code in

listing 13.10:

</P>

<P>



<CENTER>

<TABLE BGCOLOR="#FFFF99">

<TR><TD><B>

WARNING

</B></TD></TR>

<TR><TD>

<BLOCKQUOTE>

The Thread.start() method shouldn't be confused with

the Applet.start() method. Thread.start() is

called to start a separate thread of execution running.

Applet.start() is called when an applet object

should start processing.

</BLOCKQUOTE></TD></TR>

</TABLE></CENTER>

</P>



<A NAME="PAGENUM-517"><P>Page 517</P></A>







<P>Listing 13.10 Code that Uses a FileChecksum Object </P>


<PRE>

        //Create a file checksum object and get the

        //checksum.

        FileChecksum fc = new FileChecksum(&quot;a.tmp&quot;);

        int sum = fc.getChecksum();

</PRE>




<P>This code isn't aware that FileChecksum now does its work in parallel. The call

to getChecksum() comes immediately following the creation of the FileChecksum

object, when it's unlikely that the FileChecksum thread has completed reading the file.

Though getChecksum() has been changed to check whether the calculation has finished and, if

not, to return a value of _1 to indicate that the checksum isn't yet available, all the code

that uses a FileChecksum still needs to be changed to check for the _1 return value, as in

figure 13.3. Ideally, getChecksum() should wait until the checksum is available before

returning. Java supports language mechanisms to enable this, and they're discussed

later in the section on Concurrent Thread Interaction. For the moment, think of the &quot;finished&quot; flag

as a simple way for the thread that calculates the checksum to communicate with any

threads that want to obtain the result of that calculation.<BR>

</P>



<P><a href="images\ch13fg03.jpg"><img src="images\tn_ch13fg03.jpg"></a><BR>

Figure 13.3 A less than ideal way of checking whether the checksum

is available.

</P>



<H4><A NAME="ch13_ 13">

Understanding Multithreaded Code

</A></H4>



<P>When reading multithreaded code, it's important to be clear about which thread

executes what code. A method of a Runnable object can be called by any thread, not just

threads that are calling its run() method. Thus, as in the FileChecksum example in listing

13.10, any thread could call getChecksum().

</P>



<P><CENTER>

<a href="0508-0512.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0518-0521.html">Next</A>

</CENTER></P>











</BODY>
</HTML>







