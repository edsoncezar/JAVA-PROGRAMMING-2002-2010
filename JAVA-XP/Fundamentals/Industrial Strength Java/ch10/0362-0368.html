<HTML>

<HEAD>



<TITLE>Industrial Strength Java:Introducing Networking:EarthWeb Inc.-</TITLE>



















<P><CENTER>

<a href="0357-0361.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0369-0375.html">Next</A>

</CENTER></P>



<A NAME="PAGENUM-362"><P>Page 362</P></A>







<P>Listing 10.31 Continued

</P>


<PRE>

          port = Integer.parseInt(args[0]);

          new AppletServer(port, background);

        }

        catch(NumberFormatException e)

        {

          System.out.print(&quot;not a valid port number&quot;);

          System.out.println(&quot;use an integer over 1024&quot;);

          System.out.println(e);

          System.out.println();

          System.out.println(&quot;Starting server on &quot; + defaultPort);

          new AppletServer();

        }

      }

    }

    else if ((args.length == 2)  &amp;&amp; args[0] == &quot;-f&quot;)

    {

      background = false;

      try

      {

        port = Integer.parseInt(args[0]);

        new AppletServer(port, background);

      }

      catch(NumberFormatException e)

      {

        System.out.print(&quot;not a valid port number&quot;);

        System.out.println(&quot;use an integer over 1024&quot;);

        System.out.println(e);

        System.out.println();

        System.out.println(&quot;Starting server on &quot; + defaultPort);

        new AppletServer(defaultPort, background);

      }

    }

    else

      System.out.println(&quot;usage: java AppletServer [-f] [&lt;port_#&gt;]&quot;);

  }



</PRE>






<A NAME="PAGENUM-363"><P>Page 363</P></A>










<PRE>

  public AppletServer()

  {

    super();        //create thread



    try

    {

      server = new ServerSocket(defaultPort);

    }

    catch(IOException e)

    {

      System.out.println(&quot;could not create ServerSocket&quot;);

      System.out.println(e);

      System.exit(1);

    }



    tg = new ThreadGroup(&quot;Connections&quot;);

    clientList = new List();

    clientVector = new Vector();

    watcher = new Watcher(this);



    this.start();

  }



  public AppletServer(boolean background)

  {

    super();        //create thread



    try

    {

      server = new ServerSocket(defaultPort);

    }

    catch(IOException e)

    {

      System.out.println(&quot;could not create ServerSocket&quot;);

      System.out.println(e);

      System.exit(1);

    }



    tg = new ThreadGroup(&quot;Connections&quot;);

    clientList = new List();

    clientVector = new Vector();

    watcher = new Watcher(this);



    Frame f = new Frame(&quot;AppletServer Monitor&quot;);

    f.add(&quot;Center&quot;, clientList);

    f.resize(400, 300);

    f.show();

</PRE>


<PRE>
continues
</PRE>






<A NAME="PAGENUM-364"><P>Page 364</P></A>







<P>Listing 10.31 Continued

</P>






<PRE>

    this.start();

  }



  public AppletServer(int port, boolean background)

  {

      super();        //create thread



    try

    {

      server = new ServerSocket(port);

    }

    catch(IOException e)

    {

      System.out.println(&quot;could not create ServerSocket&quot;);

      System.out.println(e);

      System.exit(1);

    }



    tg = new ThreadGroup(&quot;Connections&quot;);

    clientList = new List();

    clientVector = new Vector();

    watcher = new Watcher(this);



    Frame f = new Frame(&quot;AppletServer Monitor&quot;);

    f.add(&quot;Center&quot;, clientList);

    f.resize(400, 300);

    f.show();



    this.start();

  }



  public void run()

  {

    try

    {

      for(;;)

      {

        Socket client = server.accept();

        ClientConnect cc = new ClientConnect(this, client, tg, watcher);



        synchronized(clientVector)

        {

</PRE>






<A NAME="PAGENUM-365"><P>Page 365</P></A>








<PRE>



          clientVector.addElement(cc);

          clientList.addItem(cc.toString());

        }

      }

    }

    catch(IOException e)

    {

      System.out.println(&quot;error accepting connections&quot;);

      System.out.println(e);

      System.exit(1);

    }

  }

}

</PRE>


<P>

<B>

The ClientConnect Class

</B>

</P>



<P>ClientConnect handles the communication between the server and clients. The

constructor is passed the instances of Socket and ThreadGroup to which the client belongs. It

also receives the AppletServer and Watcher variables; one instance of these covers all

client connections.The constructor then opens the DataInputStream and PrintStream, which

are used to listen for and send data to the server. The final action of the constructor is to

start the thread that handles communication.

</P>



<P>The run() method initially welcomes the client. It then enters a

loop in which it reads lines of input sent by the client. If the input line

is not null or empty, the sendtoall() method is invoked. Notice that

in the IOException thrown by java.io.DataInputStream.readLine(),

no error message is displayed. This exception is thrown if the

user leaves the page without pressing the disconnect button, thus

calling the stop() method to avoid excess messages on the screen.

Finally, the run() method closes the socket and streams, and stops the

thread, as well.

</P>



<P>ClientConnect also contains two additional methods. The

send-toone() method actually sends messages received by the server

back to the client via the PrintStream. The sendtoall() method

loops through each client in the clientVector calling sendtoone() to

act-ually send the information across the network.

</P>



<P>Listing 10.32 contains the source for the ClientConnect class.

</P>

<P>



<CENTER>

<TABLE BGCOLOR="#FFFF99">

<TR><TD><B>

NOTE

</B></TD></TR>

<TR><TD>

<BLOCKQUOTE>

You may be wondering why sendtoone() and sendtoall() are

not integrated into one method. In this example, it is

unnecessary, but the design allows for extensions to the code to

enable multiple chat channels or private messages.

</BLOCKQUOTE></TD></TR>

</TABLE></CENTER>

</P>


<PRE>
continues
</PRE>




<A NAME="PAGENUM-366"><P>Page 366</P></A>





<P>Listing 10.32 Continued

</P>





<P>Listing 10.32 ClientConnect.java

</P>




<PRE>

class ClientConnect extends Thread

{

  protected static int ID = -1;

  protected String name;

  protected Socket socket;

  protected DataInputStream dis;

  protected PrintStream ps;<BR>

  protected AppletServer gas;

  protected Watcher watcher;



  public ClientConnect(AppletServer gas, Socket socket,

    ThreadGroup tg, Watcher watcher)

  {

    super(tg, &quot;Client #&quot; + ++ID);



    this.gas = gas;

    this.socket = socket;

    this.watcher = watcher;

    name = &quot;default&quot;;



    try

    {

      dis = new DataInputStream(socket.getInputStream());

      ps = new PrintStream(socket.getOutputStream());

    }

    catch(IOException e)

    {

      System.out.println(&quot;error opening streams&quot;);

      System.out.println(e);

    }



    this.start();

  }



  public void run()

  {

    String str;

    int length;



    ps.println(&quot;Welcome to the chat room\n&quot;);



    try

</PRE>




<A NAME="PAGENUM-367"><P>Page 367</P></A>








<PRE>

    {

      for(;;)

      {

        str = dis.readLine();

        if ((str != null) || (str != &quot;&quot;))

          sendtoall(str);

        else

          break;

      }

    }

    catch(IOException e)

    {

          //No output here because an IOException will

          //be thrown if somebody leaves the chat room

          //without disconnecting. However, this does

          //not effect execution of the program.

        }



    finally

    {

      try

      {

        dis.close();

        ps.close();

        socket.close();

      }

      catch(IOException e)

      {

        System.out.println(&quot;error closing socket&quot;);

        System.out.println(e);

      }

      synchronized(watcher)

      {

        watcher.notify();

      }

    }

  }



  public void sendtoone(String s)

  {

    ps.println(s);

    ps.flush();

  }



  public void sendtoall(String s)

  {

    int clientNumber;

    clientNumber = gas.clientVector.size();

</PRE>




<A NAME="PAGENUM-368"><P>Page 368</P></A>






<PRE>



    for (int i = 0; i &lt; clientNumber; i++)

    {

      ClientConnect cc =

        (ClientConnect)gas.clientVector.elementAt(i);

      cc.sendtoone(s);

    }

  }

}

</PRE>






<P>

<B>

The Watcher Class

</B>

</P>

<P>Watcher is the final class that is part of the AppletServer application. It monitors

the clients to see whether they are connected and deletes records of disconnected clients

from the Vector in which they are stored, as well as the list that is displayed on the console

of the server. The constructor is passed the instance of AppletServer. It then starts the

thread, which does all of the work.

</P>



<P>The run() method consists of one loop. The thread pauses for 2.5 seconds each

time through the loop and then goes through the clientVector, which contains information

about clients, to see whether their threads are alive. If the thread is dead, it removes all

references to it. The source code is shown in listing 10.33.

</P>



<P>Listing 10.33 Watcher.java

</P>




<PRE>

class Watcher extends Thread

{

 AppletServer gas;

 int clientNumber;



 Watcher(AppletServer gas)

 {

  super(gas.tg, &quot;Connection Monitor&quot;);

  this.gas = gas;

  this.start();

 }



 public synchronized void run()

 {

  for(;;)

  {

   try

   {

    this.wait(2500);

</PRE>




<P><CENTER>

<a href="0357-0361.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0369-0375.html">Next</A>

</CENTER></P>











</BODY>
</HTML>







