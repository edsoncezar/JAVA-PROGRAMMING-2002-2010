<HTML>

<HEAD>



<TITLE>Industrial Strength Java:Introducing Networking:EarthWeb Inc.-</TITLE>



















<P><CENTER>

<a href="0353-0356.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0362-0368.html">Next</A>

</CENTER></P>



<A NAME="PAGENUM-357"><P>Page 357</P></A>








<PRE>

     //constructor is passed address applet originated at

    public NetTest(InetAddress ia)

    {

        this.ia = ia;

    }

</PRE>














<P>Listing 10.28 consists of the test() method, which is called whenever the user presses

the button to send a packet. Test creates the DatagramSocket to send and receive packets and

</P>



<P>a DatagramPacket to be sent. It uses a thread to keep track of the amount of time

between when the packet was sent and returned. It returns this value to the piece of code that called it.

</P>



<P>Listing 10.28 NetTest.java Second of Three

</P>


<PRE>

   public long test()

   {

     byte[] b = new byte[1];

     b[0] = ++number;

     time = -1;



     try

     {

       dgsock = new DatagramSocket();

     }

     catch (Exception e)

     {

       System.out.println(&quot;Could not create DatagramSocket&quot;);

       System.out.println(e);

     }



     if (listen == null)

     {

       listen = new Thread(this);

       listen.start();

     }



     DatagramPacket packet = new DatagramPacket(b, b.length, ia,echoPort);

     timesent = System.currentTimeMillis();

     long dieTime = timesent + maxTime;



     try

     {

</PRE>


<PRE>
continues
</PRE>








<A NAME="PAGENUM-358"><P>Page 358</P></A>



<P>Listing 10.28 Continued

</P>








<PRE>

       dgsock.send(packet);

       while (System.currentTimeMillis() &lt; dieTime)

       {

         Thread.sleep(interval);

         if(time != -1)

           return(time);

       }

     }

     catch (Exception e)

     {

         System.out.println(&quot;Error sending packet.&quot;);

        System.out.println(e);

     }

      //return what is probably -1, error handling

      //is in actual applet code

     return(time);

   }

</PRE>




<P>Listing 10.29 consists of the run() and stop() methods. The run() method is used to

listen for incoming (returned) DatagramPackets. The stop() method simply kills the listen

thread and then closes the DatagramSocket, returning the port to the system.

</P>



<P>Listing 10.29 NetTest.java Third of Three

</P>


<PRE>

   // Run method for the listen thread

  public void run()

  {

    byte[] b2 = new byte[1];

    DatagramPacket packet = new DatagramPacket(b2, b2.length);



    try

    {

      while (true)

       {

         dgsock.receive(packet);

         if(b2[0] == number)

         {

           time = System.currentTimeMillis() - timesent;

           listen = null;

           return;

         }

       }

     }

     catch (Exception e)

     {



</PRE>




<A NAME="PAGENUM-359"><P>Page 359</P></A>






<PRE>

       System.out.println(&quot;Could not receive packet&quot;);

        System.out.println(e);

       listen = null;

       return;

     }

  }

  // make sure thread dies and the socket is closed

  public void stop()

  {

    if (listen != null)

      {

        listen.stop();

      }

    dgsock.close();

  }

}

</PRE>


<P>

<B>

NetSpeed and NetTest Wrap-Up

</B>

</P>



<P>The NetSpeed program enables the user to see how long it takes to bounce a packet

back and forth between his machine and the machine on which the applet resides. From

this example you should have become familiar with using the java.net package in the

applet environment, and you should have a basic understanding of how the limitations of

java.net affect your programming.

</P>



<P>Listing 10.30 shows a bare-bones HTML file that you can modify to place the applet

on your page.

</P>



<P>Listing 10.30 netspeed.html

</P>




<PRE>

&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML//EN&quot;&gt;

&lt;HTML&gt;

&lt;HEAD&gt;

&lt;TITLE&gt;

NetSpeed test page

&lt;/TITLE&gt;

&lt;/HEAD&gt;



&lt;BODY&gt;

The applet should be below this line

&lt;HR&gt;

&lt;P&gt;



&lt;APPLET code = &quot;NetSpeed.class&quot; width=400 height=200&gt;

&lt;/APPLET&gt;



&lt;HR&gt;

The applet should be above this line

</PRE>




<A NAME="PAGENUM-360"><P>Page 360</P></A>






<PRE>

&lt;P&gt;



&lt;/BODY&gt;

&lt;/HTML&gt;

</PRE>












<H3><A NAME="ch10_ 21">

Chatting and Sockets

</A></H3>



<P>If you are an experienced network programmer, or a fast learner, you probably

are growing tired of trivial examples. To conclude this chapter, you will learn how to write

a chat applet and server&#151;a popular example for learning because it requires threads

for multiuser support and an understanding of how to write to and read from sockets using

the java.io classes. Many fancy chat applets can be found on the web; this one is fairly

vanilla. The goal in the remainder of the chapter is to introduce you to multithreaded

network code. Threads are a necessity if a server is going to support more than one client at a

time (see Chapter 13, &quot;Thinking in Terms of Threads&quot;). The client also uses threads to listen

for messages from the server while receiving input and sending messages.

</P>



<P>As you look over the code, notice that it has been intentionally broken up into

more classes and methods than are necessary for an application of this complexity.

AppletServer and ChatApplet have been designed as examples for you to experiment with and

expand. To quote Professor Doug Harris, &quot;Programming is not a spectator sport.&quot; The best

thing for you to do when you finish this chapter is to tinker with and build onto these classes.

</P>



<H4><A NAME="ch10_ 22">

The Chat Server

</A></H4>



<P>This section initiates the development of the server. It consists of three classes:

</P>



<UL>

<LI>     AppletServer. Contains the constructors for the server as well as the

main() method. It also receives the initial connection from the client.

<LI>     ClientConnect. Constructed for each client connection, ClientConnect handles

all further communication between the client and server. It welcomes new clients

and then waits for messages to be received. It returns each message received to

each client, including the sender.

<LI>     Watcher. Loops infinitely checking to see whether the client that created

each instance of ClientConnect is still connected. If not, it updates the

AppletServer's display and closes the socket.

</UL>



<P>The server is presented in three sections, one for each class. The first class presented

is

</P>



<A NAME="PAGENUM-361"><P>Page 361</P></A>





<P>AppletServer. The main() method simply invokes one of three constructors. If the server

is launched with the command &quot;java

AppletServer,&quot; the default port, 1976, is used.

An optional flag, -f, calls the second constructor, causing the server to pop up a frame

that displays a list of each client. The list displays the ID of each client, as well as the host

of the client. Finally, the server may be launched using both the -f flag and a specified

port number, &quot;java AppletServer -f &lt;port_#&gt;.&quot;

</P>









<B>

The AppletServer Class

</B>



<P>Each constructor creates the thread in which the server runs and initializes a

ServerSocket. If the user specifies at the command line, a Frame with a List is created and

displayed. The run() method causes the ServerSocket to listen for and accept connections. When

a connection is made, an instance of ClientConnect is created, and the new client is added

to the list displayed on the screen if applicable (see listing 10.31).

</P>



<P>Listing 10.3 1AppletServer.java

</P>


<PRE>

import java.net.*;

import java.io.*;

import java.util.*;

import java.awt.*;

import java.lang.*;



public class AppletServer extends Thread

{

  protected final static int defaultPort = 1976;

  protected int paramPort;

  protected ServerSocket server;

  protected ThreadGroup tg;

  protected List clientList;

  protected Vector clientVector;

  protected Watcher watcher;



  public static void main(String[] args)

  {

    int port = -1;

    boolean background = true;



    if (args.length == 0)

      new AppletServer();

    else if (args.length == 1)

    {

      if (args[0].equals(&quot;-f&quot;))

      {

        background = false;

        new AppletServer(background);

      }

      else

      {

        try

        {

</PRE>


<PRE>
continues
</PRE>




<P><CENTER>

<a href="0353-0356.html">Previous</A> | <a href="..\ewtoc.html">Table of Contents</A> | <a href="0362-0368.html">Next</A>

</CENTER></P>











</BODY>
</HTML>







