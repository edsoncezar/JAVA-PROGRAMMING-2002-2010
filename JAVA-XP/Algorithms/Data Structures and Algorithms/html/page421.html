<HTML>
<HEAD>
<TITLE>Reference Counting Garbage Collection</TITLE>
</HEAD>
<BODY bgcolor="#FFFFFF">
 <img src="..\icons\cover75.gif" alt="Cover" align=right>
<b>Data Structures and Algorithms 
with Object-Oriented Design Patterns in Java</b><br>
<A NAME="tex2html7100" HREF="page422.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="..\icons\next_motif.gif"></A> <A NAME="tex2html7098" HREF="page414.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="..\icons\up_motif.gif"></A> <A NAME="tex2html7092" HREF="page420.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="..\icons\previous_motif.gif"></A> <A NAME="tex2html7102" HREF="page9.html"><IMG WIDTH=65 HEIGHT=24 ALIGN=BOTTOM ALT="contents" SRC="..\icons\contents_motif.gif"></A> <A NAME="tex2html7103" HREF="page618.html"><IMG WIDTH=43 HEIGHT=24 ALIGN=BOTTOM ALT="index" SRC="..\icons\index_motif.gif"></A> <BR><HR>
<H1><A NAME="SECTION0014200000000000000000">Reference Counting Garbage Collection</A></H1>
<P>
The difficulty in garbage collection is not
the actual process of collecting the garbage--it is the problem of finding the garbage in the first place.
An object is considered to be garbage
when no references to that object exist.
But how can we tell when no references to an object exist?
<P>
A simple expedient is to keep track in each object
of the total number of references to that object.
That is, we add a special field to each object called
a <em>reference count</em><A NAME=29533>&#160;</A><A NAME=29534>&#160;</A><A NAME=29535>&#160;</A>.
The idea is that the reference count field is not accessible to
the Java program.
Instead, the reference count field is updated by
the Java virtual machine itself.
<P>
Consider the statement
<PRE>Object p = new Integer (57);</PRE>
which creates a new instance of the <tt>Integer</tt> class.
Only a single variable, <tt>p</tt>, refers to the object.
Thus, its reference count should be one.
<P>
<P><A NAME="29609">&#160;</A><A NAME="figgarbage1">&#160;</A> <IMG WIDTH=575 HEIGHT=108 ALIGN=BOTTOM ALT="figure29538" SRC="img1703.gif"  ><BR>
<STRONG>Figure:</STRONG> Objects with reference counters.<BR>
<P>
<P>
Now consider the following sequence of statements:
<PRE>Object p = new Integer (57);
Object q = p;</PRE>
This sequence creates a single <tt>Integer</tt> instance.
Both <tt>p</tt> and <tt>q</tt> refer to the same object.
Therefore, its reference count should be two.
<P>
In general, every time one reference variable is assigned to another,
it may be necessary to update several reference counts.
Suppose <tt>p</tt> and <tt>q</tt> are both reference variables.
The assignment
<PRE>p = q;</PRE>
would be implemented by the Java virtual machine as follows:
<PRE>if (p != q)
{
    if (p != null)
	--p.refCount;
    p = q;
    if (p != null)
	++p.refCount;
}</PRE>
<P>
For example suppose <tt>p</tt> and <tt>q</tt> are initialized as follows:
<PRE>Object p = new Integer (57);
Object q = new Integer (99);</PRE>
As shown in Figure&nbsp;<A HREF="page421.html#figgarbage2"><IMG  ALIGN=BOTTOM ALT="gif" SRC="..\icons\cross_ref_motif.gif"></A>&nbsp;(a),
two <tt>Integer</tt> objects are created,
each with a reference count of one.
Now, suppose we assign <tt>q</tt> to <tt>p</tt>
using the code sequence given above.
Figure&nbsp;<A HREF="page421.html#figgarbage2"><IMG  ALIGN=BOTTOM ALT="gif" SRC="..\icons\cross_ref_motif.gif"></A>&nbsp;(b) shows that after the assignment,
both <tt>p</tt> and <tt>q</tt> refer to the same object--its reference count is two.
And the reference count on <tt>Integer(57)</tt> has gone to zero
which indicates that it is garbage.
<P>
<P><A NAME="29830">&#160;</A><A NAME="figgarbage2">&#160;</A> <IMG WIDTH=575 HEIGHT=162 ALIGN=BOTTOM ALT="figure29627" SRC="img1704.gif"  ><BR>
<STRONG>Figure:</STRONG> Reference counts before and after the assignment <tt>p = q</tt>.<BR>
<P>
<P>
The costs of using reference counts are twofold:
First, every object requires the special reference count field.
Typically, this means an extra word of storage
must be allocated in each object.
Second, every time one reference is assigned to another,
the reference counts must be adjusted as above.
This increases significantly the time taken by assignment statements.
<P>
The advantage of using reference counts
is that garbage is easily identified.
When it becomes necessary to reclaim the storage from unused objects,
the garbage collector needs only to examine the reference count fields
of all the objects that have been created by the program.
If the reference count is zero, the object is garbage.
<P>
It is not necessary to wait until there is insufficient memory
before initiating the garbage collection process.
We can reclaim memory used by an object immediately
when its reference goes to zero.
Consider what happens if we implement the Java assignment
<tt>p = q</tt>
in the Java virtual machine as follows:
<PRE>if (p != q)
{
    if (p != null)
	if (--p.refCount == 0)
	    heap.release (p);
    p = q;
    if (p != null)
	++p.refCount;
}</PRE>
Notice that the <tt>release</tt> method is invoked immediately
when the reference count of an object goes to zero,
i.e., when it becomes garbage.
In this way, garbage may be collected incrementally as it is created.
<P>
<BR> <HR>
<UL> 
<LI> <A NAME="tex2html7104" HREF="page422.html#SECTION0014210000000000000000">When Objects Refer to Other Objects</A>
<LI> <A NAME="tex2html7105" HREF="page423.html#SECTION0014220000000000000000">Why Reference Counting Does Not Work</A>
</UL>
<HR><A NAME="tex2html7100" HREF="page422.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="..\icons\next_motif.gif"></A> <A NAME="tex2html7098" HREF="page414.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="..\icons\up_motif.gif"></A> <A NAME="tex2html7092" HREF="page420.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="..\icons\previous_motif.gif"></A> <A NAME="tex2html7102" HREF="page9.html"><IMG WIDTH=65 HEIGHT=24 ALIGN=BOTTOM ALT="contents" SRC="..\icons\contents_motif.gif"></A> <A NAME="tex2html7103" HREF="page618.html"><IMG WIDTH=43 HEIGHT=24 ALIGN=BOTTOM ALT="index" SRC="..\icons\index_motif.gif"></A> <P><ADDRESS>
<img src="..\icons\bruno.gif" alt="Bruno" align=right>
<a href="..\copyright.html">Copyright &#169; 1998</a> by <a href="..\signature.html">Bruno R. Preiss, P.Eng.</a>  All rights reserved.

</ADDRESS>
</BODY>
</HTML>
