<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<!-- saved from url=(0091)http://developer.java.sun.com/developer/technicalArticles/JavaLP/Interposing/?frontpage-jdc -->
<HTML><HEAD><TITLE>Using java.lang.reflect.Proxy to Interpose on Java Class Methods</TITLE>
<META content="text/html; charset=windows-1252" http-equiv=Content-Type>
<META content="Tom Harpin" name=AUTHOR>
<META content=article name=DESCRIPTION>
<META content="Java, Interposing" name=KEYWORDS>
<META content=Editorial/JDC name=OWNER>
<META content="@(#)index2.src&#9;1.2 06/09/99  JDC" name=revision><!-- Start Body Insert-->
<STYLE type=text/css>CODE {
	FONT-FAMILY: Courier, Monospace; FONT-SIZE: 12pt
}
PRE {
	FONT-FAMILY: Courier, Monospace; FONT-SIZE: 11pt
}
BODY {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
DIV {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
SPAN {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
TD {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
TH {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
TR {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
TABLE {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
P {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
LI {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
BR {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
SUP {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
H1 {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
H2 {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
H3 {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
H4 {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
H5 {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
H6 {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
BLOCKQUOTE {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
INPUT {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
SELECT {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
TEXTAREA {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
FORM {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
UL {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
OL {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
FONT {
	FONT-FAMILY: Verdana, Arial, Helvetica, sans-serif
}
</STYLE>

<META content="MSHTML 5.00.2314.1000" name=GENERATOR></HEAD>
<BODY aLink=#ff0000 bgColor=#ffffff link=#0000ff text=#000000 vLink=#660066><!--========================--><!--===== JAVA SCRIPT ======--><!--========================-->
<SCRIPT language=JavaScript>
<!--
function printpage() {
        self.location = "/servlet/PrintPageServlet?url=" + escape(document.URL);
}
// -->
</SCRIPT>

<SCRIPT language=JavaScript type=text/javascript>

<!--
function gotoFunction() {
        self.location = 
document.productGoto.url.options[document.productGoto.url.selectedIndex].value;
}
function goFunction() {
        self.location = 
document.productGo.url.options[document.productGo.url.selectedIndex].value;
}
// -->

</SCRIPT>
<!--========================--><!--=== END JAVA SCRIPT ====--><!--========================--><!-- End Body Insert--><!-- Start PageTop Insert -->
<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
  <TBODY>
  <TR align=middle vAlign=top>
    <TD align=left width=157><IMG alt="" height=40 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
      width=40> <A href="http://java.sun.com/index.html"><IMG 
      alt="Java Technology Home Page" border=0 height=88 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/javalogo52x88.gif" 
      width=52></A> <BR><IMG alt="" height=1 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
      width=157></TD>
    <TD>
      <FORM action=http://search.java.sun.com/query.html method=get name=seek1>
      <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
        <TBODY>
        <TR>
          <TD align=right><IMG alt="" height=14 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/stripelt.gif" 
            width=6></TD>
          <TD width="100%">
            <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
              <TBODY>
              <TR>
                <TD bgColor=#cc9966 width="100%"><IMG alt="" height=2 
                  src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
                  width=1></TD></TR>
              <TR>
                <TD><IMG alt="" height=2 
                  src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
                  width=1></TD></TR>
              <TR>
                <TD bgColor=#cc9966><IMG alt="" height=2 
                  src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
                  width=1></TD></TR>
              <TR>
                <TD><IMG alt="" height=2 
                  src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
                  width=1></TD></TR>
              <TR>
                <TD bgColor=#cc9966><IMG alt="" height=2 
                  src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
                  width=1></TD></TR>
              <TR>
                <TD><IMG alt="" height=2 
                  src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
                  width=1></TD></TR>
              <TR>
                <TD bgColor=#cc9966><IMG alt="" height=2 
                  src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
                  width=1></TD></TR></TBODY></TABLE></TD>
          <TD align=left><IMG alt="" height=14 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/stripert.gif" 
            width=6></TD>
          <TD>
            <TABLE border=0 cellPadding=0 cellSpacing=0>
              <TBODY>
              <TR>
                <TD vAlign=center width=72><A 
                  href="http://java.sun.com/a-z/index.html"><IMG alt="A-Z Index" 
                  border=0 height=11 
                  src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/azindex.gif" 
                  width=72></A></TD>
                <TD vAlign=center><FONT size=1><INPUT maxLength=128 name=qt 
                  size=15></FONT></TD>
                <TD vAlign=center width=55><INPUT alt=Search border=0 
                  src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/search.button.gif" 
                  type=image value=search 
        width=55></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></FORM>
      <P>
      <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
        <TBODY>
        <TR vAlign=top>
          <TD width="100%"><IMG alt="" height=18 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/chiclet.row.gif" 
            width=55></TD>
          <TD align=right rowSpan=4 width=152><A 
            href="http://developer.java.sun.com/developer/index.html"><IMG 
            alt="Java Developer Connection(SM)" border=0 height=42 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/developer.connection.header.gif" 
            width=319></A></TD></TR>
        <TR vAlign=top>
          <TD bgColor=#ffffff height=1 width="100%"><IMG alt="" height=1 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
            width=1></TD></TR>
        <TR vAlign=top>
          <TD bgColor=#cc9966 height=1 width="100%"><IMG alt="" height=1 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
            width=1></TD></TR>
        <TR vAlign=top>
          <TD><A 
            href="http://developer.java.sun.com/developer/technicalArticles/"><IMG 
            alt="Technical Articles" border=0 height=22 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/technical-articles.gif" 
            width=165></A></TD></TR></TBODY></TABLE></P></TD></TR></TBODY></TABLE><!-- End PageTop Insert --><!-- Start NavBar Insert -->
<TABLE align=left bgColor=#ffffff border=0 cellPadding=3 cellSpacing=0 
width=157><!-- tab categories -->
  <TBODY>
  <TR>
    <TD><A href="http://java.sun.com/products/"><IMG 
      alt="Downloads, APIs, Documentation" border=0 height=15 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/side.tab.products.gif" 
      width=130></A></TD></TR>
  <TR>
    <TD><A href="http://developer.java.sun.com/developer/"><IMG 
      alt="Java Developer Connection" border=0 height=15 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/side.tab.developer.gif" 
      width=130></A></TD></TR>
  <TR>
    <TD><A href="http://developer.java.sun.com/developer/infodocs/"><IMG 
      alt="Tutorials, Tech Articles, Training" border=0 height=15 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/side.tab.docs.gif" 
      width=130></A></TD></TR>
  <TR>
    <TD><A href="http://developer.java.sun.com/developer/support/"><IMG 
      alt="Online Support" border=0 height=15 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/side.tab.support.gif" 
      width=130></A></TD></TR>
  <TR>
    <TD><A href="http://developer.java.sun.com/developer/community/"><IMG 
      alt="Community Discussion" border=0 height=15 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/side.tab.community.gif" 
      width=130></A></TD></TR>
  <TR>
    <TD><A href="http://java.sun.com/industry/"><IMG 
      alt="News &amp; Events from Everywhere" border=0 height=15 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/side.tab.news.gif" 
      width=130></A></TD></TR>
  <TR>
    <TD><A href="http://java.sun.com/solutions"><IMG 
      alt="Products from Everywhere" border=0 height=15 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/side.tab.solutions.gif" 
      width=130></A></TD></TR>
  <TR>
    <TD><A href="http://java.sun.com/casestudies"><IMG 
      alt="How Java Technology is Used Worldwide" border=0 height=15 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/side.tab.case.gif" 
      width=130></A></TD></TR>
  <TR>
    <TD><!-- End NavBar Insert --><!-- START SUB-NAV --><!--========================--><!--========================--><!--=== Begin Categories ===--><!--========================--><!--========================-->
  <TR>
    <TD>
      <TABLE align=left border=0 cellPadding=0 width="100%">
        <TBODY>
        <TR>
          <TD align=left width="100%"><A 
            href="http://developer.java.sun.com/servlet/PrintPageServlet" 
            onclick="javascript:printpage();return false;"><IMG 
            alt="Print Button" border=0 height=25 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/printable.gif" 
            width=156></A>
            <P><IMG alt="Members Only" height=7 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/chiclet.gif" 
            width=7> <FONT size=-1><B>Requires login</B></FONT><BR><BR><!--==========================--><!--====== EARLY ACCESS ======--><!--==========================--><FONT 
            color=#993333 size=3><B>Early Access</B></FONT> <IMG 
            alt="Members Only" height=7 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/chiclet.gif" 
            width=7> </P></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/earlyAccess/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Downloads</B></A><BR><BR></FONT></TD></TR><!--==========================--><!--===== BUG DATABASE =======--><!--==========================-->
        <TR>
          <TD><FONT color=#993333 size=3><B>Bug Database</B></FONT> <IMG 
            alt="Members Only" height=7 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/chiclet.gif" 
            width=7><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://java.sun.com/cgi-bin/bugreport.cgi/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Submit a 
            Bug</B></A></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/bugParade/index.jshtml" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>View 
            Database</B></A></FONT><BR><BR></TD></TR><!--==========================--><!--====== NEWSLETTERS =======--><!--==========================-->
        <TR>
          <TD><FONT color=#993333 size=3><B>Newsletters</B></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/techDocs/Newsletters/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Back 
            Issues</B></A></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/subscription/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Subscribe</B></A></FONT><BR><BR></TD></TR><!--==========================--><!--==== LEARNING CENTERS ====--><!--==========================-->
        <TR>
          <TD><FONT color=#993333 size=3><B>Learning 
        Centers</B></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/technicalArticles/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Articles</B></A></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/Books/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Bookshelf</B></A></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/codesamples/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Code 
            Samples</B></A></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/onlineTraining/new2java/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>New to 
            Java</B></A></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/qow/archive/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Question of the 
            Week</B></A></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/Quizzes/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Quizzes</B></A></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/TechTips/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Tech 
            Tips</B></A></FONT><BR></TD></TR>
        <TR>
          <TD><FONT size=2><A 
            href="http://developer.java.sun.com/developer/onlineTraining/" 
            style="COLOR: #666699; TEXT-DECORATION: none"><B>Tutorials</B></A></FONT><BR><BR></TD></TR><!--==========================--><!--======== FORUMS ==========--><!--==========================-->
        <TR>
          <TD><FONT size=3><A href="http://forum.java.sun.com/" 
            style="COLOR: #993333; TEXT-DECORATION: none"><B>Forums</B></A></FONT><BR><BR></TD></TR></TBODY></TABLE></TD></TR><!--=========================--><!--== TECHNOLOGY CENTERS ===--><!--=========================-->
  <TR>
    <TD><!--========================--><!--========================--><!--===== JAVA SCRIPT ======--><!--========================--><!--========================--><!--begin pop-down menus-->
      <FORM action=/servlet/RedirectServlet class=mstmnu method=post 
      name=productGo><FONT color=#993333 size=3><B>Technology Centers</B></FONT> 
      <BR><FONT size=3><SELECT name=url onblur="return options[0].selected=true" 
      onchange=goFunction()> <OPTION selected value=#>SELECT</OPTION> <OPTION 
        value=/developer/products/java2cs/>- Community</OPTION> <OPTION 
        value=/developer/products/java2cs/>Source Area</OPTION> <OPTION 
        value=/developer/products/java2cs/></OPTION> <OPTION 
        value=/developer/products/j2ee/>- Enterprise</OPTION> <OPTION 
        value=/developer/products/j2ee/></OPTION> <OPTION 
        value=/developer/products/jini/>- Jini Network</OPTION> <OPTION 
        value=/developer/products/jini/>Technology</OPTION> <OPTION 
        value=/developer/products/jini/></OPTION> <OPTION 
        value=/developer/products/wireless/>- Wireless</OPTION> <OPTION 
        value=/developer/products/wireless/></OPTION> <OPTION 
        value=/developer/products/>- more . . .</OPTION> <OPTION 
        value=/developer/products/></OPTION></SELECT> </FONT>
      <DIV align=left><INPUT alt=Go border=0 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/my_go.gif" 
      type=image> </DIV></FORM></TD></TR><!--========================--><!--========================--><!--=== End   Categories ===--><!--========================--><!--========================--><!-- START SUB-NAV -->
  <TR>
    <TD><!-- INSERT SUB-NAV INFO --></FONT></TD></TR><!-- END SUB-NAV --></TBODY></TABLE>
<TABLE border=0 cellPadding=0 cellSpacing=0>
  <TBODY>
  <TR>
    <TD><!-- Template Version 2.0 --><!-- ================== --><!-- Start Main Content --><!-- ================== -->
      <DIV align=right><FONT size=-1><A 
      href="http://developer.java.sun.com/developer/technicalArticles/index.html">Articles 
      Index</A></FONT> 
      <H2 align=right>Using java.lang.reflect.Proxy to Interpose on 
      Java<SUP><FONT size=-2>TM</FONT></SUP> Class Methods</H2><BR><B>By Tom 
      Harpin</B><BR><I>July 2001</I></FONT> </DIV>
      <P>
      <P>Library interposition has proven to be a very useful technique in C 
      language programming. With this approach, it is not necessary to recompile 
      any existing source code--or even have access to the source code--in order 
      to trace, profile or debug function calls. The goal of this technical 
      article is to explore a technique for interposing on Java<SUP><FONT 
      size=-2>TM</FONT></SUP> methods. 
      <P>
      <H3>Solaris Library Interposition</H3>
      <P>The following example uses interposition to record the frequency of 
      <CODE>malloc</CODE>, <CODE>calloc</CODE> and <CODE>realloc</CODE> system 
      calls for various amounts of memory, and displays the results in a 
      histogram. A shared library called <CODE>malloc_hist.so</CODE> redefines 
      the functions: <CODE>malloc</CODE>, <CODE>calloc</CODE>, 
      <CODE>realloc</CODE> as follows: 
      <P><PRE>   void * malloc(size_t size)
    {
        static void * (*func)();
        void * ret;

        if(!func) {
            func = (void *(*)()) 
            dlsym(RTLD_NEXT, "malloc");
        }

        ret = func(size);

        bump_counter(&amp;mdata, size);
  
        return(ret);
    }

    void * calloc(size_t nelem, size_t elsize)
    {
        static void * (*func)();
        void * ret;
        int i;

        if(!func)
            func = (void *(*)()) 
            dlsym(RTLD_NEXT, "calloc");

        ret = func(nelem, elsize);

        for(i=0;i&lt;nelem;i++)
            bump_counter(&amp;cdata, elsize);
  
        return(ret);
    }

    void * realloc(void *ptr, size_t size)
    {
        static void * (*func)();
        void * ret;

        if(!func)
            func = (void *(*)()) 
            dlsym(RTLD_NEXT, "realloc");

        ret = func(ptr, size);
        bump_counter(&amp;rdata, size);
  
        return(ret);
    }

</PRE>
      <P>The redefined exit function collects the memory allocation information 
      stored in some data structures and prints it to a file. 
      <P>Setting the LD_PRELOAD environment variable to (some 
      path)/malloc_hist.so ensures that the user-defined functions are loaded 
      first. After some pre-processing, the system malloc functions are loaded 
      (if necessary) and called. For more information about LD_PRELOAD and 
      runtime linking, see the <A 
      href="http://docs.sun.com/ab2/coll.45.13/LLM/@Ab2PageView/4348?Ab2Lang=C&amp;Ab2Enc=iso-8859-1">Linkers 
      and Libraries Guide</A>. 
      <P>
      <H3>Java Method Interposition</H3>
      <P>An equivalent technique could be very useful for developers in tracing, 
      profiling and debugging Java programs. Proxy class methods could be 
      interposed in order to examine arguments, record the frequency of calls, 
      timing information, and so forth, before or after calling the original 
      method. This technique is not quite as simple for methods, however, since 
      Java is a pure object-oriented language which does not allow any 
      stand-alone (global) functions. Methods are not loaded individually, as C 
      functions are, but rather are loaded as part of the class within which 
      they are defined. Therefore, any override must start at the class level 
      rather than at the method level. The CLASSPATH environment variable plays 
      a role here similar to what LD_LIBRARY_PATH does for C programs. It 
      provides an ordered search path for the classloader to find a needed 
      classfile. 
      <P>At class load time, the interposed class must be found before the 
      original one. This can be readily accomplished through manipulation of the 
      CLASSPATH environment variable or a -classpath switch on the commandline. 
      The interposed class must have the same full name as the original. For 
      example, a class <CODE>Foo</CODE> may exist in package 
      <CODE>pub.foo</CODE> and create an instance of class <CODE>Bar</CODE> from 
      package <CODE>pub.bar</CODE>. Creating a file <CODE>Bar.java</CODE> in 
      another directory, such as <CODE>fake/pub/bar</CODE> and prepending 
      <CODE>/fake</CODE> to the classpath, ensures that the JVM will load our 
      definition of class <CODE>pub.bar.Bar</CODE> rather than the original. In 
      this way, we can interpose our definitions of Bar's methods over the 
      originals. 
      <P>There is a problem, however, if we now wish to dispatch to the original 
      method. Since each classloader maintains a cache of unique class names, 
      the interposed and original classes <CODE>pub.bar.Bar</CODE> cannot 
      coexist in the same classloader's namespace. Therfore, the original class 
      must be loaded by a separate classloader (using a different classpath) and 
      a technique must be devised to "trampoline" from the interposed method 
      call to the original. 
      <P>
      <H3>Proxy Class Interposition</H3>
      <P>Before tackling those problems, let's look at a built-in Java language 
      facility that can be used to simulate much of the functionality provided 
      by C language interposition. J2SE v1.3 has introduced a dynamic proxy 
      class in the Java Reflection package. A dynamic proxy class implements a 
      list of interfaces specified at runtime such that a method invocation 
      through one of the interfaces on an instance of the class will be encoded 
      and dispatched to another object through a uniform interface. Proxy 
      classes and instances are created using static methods of the 
      <CODE>java.lang.reflect.Proxy</CODE> class. The 
      <CODE>Proxy.getProxyClass</CODE> method returns the 
      <CODE>java.lang.Class</CODE> object for a proxy class given a class loader 
      and an array of interfaces. The proxy class will be defined in the 
      specified class loader and will implement all of the supplied interfaces. 
      Each proxy class has one public constructor that takes one argument, an 
      implementation of the <CODE>java.lang.reflect.InvocationHandler</CODE> 
      interface. Rather than having to use the reflection API to access the 
      public constructor, a proxy instance can be also be created by calling the 
      <CODE>Proxy.newProxyInstance</CODE> method, which combines the actions of 
      calling <CODE>Proxy.getProxyClass</CODE> and invoking the constructor with 
      an invocation handler. 
      <P>For example: <BR><PRE>    public class TraceProxy 
    implements java.lang.reflect.InvocationHandler {

    public static Object newInstance(Object obj) {
        return java.lang.reflect.Proxy.newProxyInstance(
                obj.getClass().getClassLoader(),
                obj.getClass().getInterfaces(),
                new TraceProxy(obj));
         }
     ...
   }

</PRE>
      <P>Once a new proxy instance has been created, it is legal to cast it to 
      any one of the interfaces that it implements, and to call any method 
      supported by that interface. 
      <P>For example: <BR><PRE>    Bar b = (Bar) 
    TraceProxy.newInstance(new BarImpl());
    b.hello();
</PRE>
      <P>Method invocations on an instance of a dynamic proxy class are 
      dispatched to the <CODE>invoke</CODE> method in the instance's invocation 
      handler, and they are encoded with a <CODE>java.lang.reflect.Method</CODE> 
      object identifying the method that was invoked and an array of type Object 
      containing the arguments. Arguments of primitive types are wrapped in an 
      instance of the appropriate primitive wrapper class, such as 
      <CODE>java.lang.Integer</CODE> or <CODE>java.lang.Boolean</CODE>. The 
      implementation of the <CODE>invoke</CODE> method is free to modify the 
      contents of this array. 
      <P>With this facility, we may create our own proxy class which can 
      intercept a method call, do some pre-processing, invoke the original 
      method, then do some post-processing. This is exactly the method 
      interposing behavior that we seek! 
      <P>For example: <BR><PRE>    public Object invoke(Object proxy, 
    Method m, Object[] args) throws Throwable
    {
        Object result;
        try {
            System.out.print("begin method " + m.getName() + "(");
            for(int i=0; i&lt;args.length; i++) {
               if(i&gt;0) System.out.print(",");
                  System.out.print(" " + args[i].toString());
            }
            System.out.println(" )");
            result = m.invoke(obj, args);
        } catch (InvocationTargetException e) {
            throw e.getTargetException();
        } catch (Exception e) {
            throw new RuntimeException
            ("unexpected invocation exception: " +
                                        e.getMessage());
        } finally {
            System.out.println("end method " + m.getName());
        }
        return result;
    }
</PRE>
      <P>Following is the complete code for a simple example of method 
      interposing using a dynamic proxy class. 
      <P><B>Foo.java</B>
      <P><PRE>    package pub.foo;

    import pub.bar.*;
    import pub.proxy.*;

    public class Foo {
    
        public static void main(String[] args) {
            Bar bar = (Bar) 
            TraceProxy.newInstance(new BarImpl());
            bar.hello(2001, "xxx");
            bar.goodbye("yyy", 2002);
        }
}
</PRE>
      <P><B>Bar.java</B>
      <P><PRE>    package pub.bar;

    import java.io.*;

    public interface Bar {
        public void hello(int i, String s);
        public void goodbye(String s, int i);
    }
</PRE>
      <P><B>BarImpl.java</B> 
      <P><PRE>    package pub.bar;

    import java.io.*;

    public class BarImpl implements Bar {
        public void hello(int i, String s) {
            System.out.println
            ("   in pub.bar.Bar.hello");
        }

        public void goodbye(String str, int i) {
            System.out.println
            ("   in pub.bar.Bar.goodbye");
        }
    }
</PRE>
      <P><B>TraceProxy.java</B> 
      <P><PRE>    package pub.proxy;

    import java.lang.reflect.*;
    import pub.bar.*;

    public class TraceProxy 
    implements java.lang.reflect.InvocationHandler {

        private Object obj;

        public static Object newInstance(Object obj) {
            return java.lang.reflect.Proxy.newProxyInstance(
                    obj.getClass().getClassLoader(),
                    obj.getClass().getInterfaces(),
                    new TraceProxy(obj));
        }

        private TraceProxy(Object obj) {
            this.obj = obj;
        }

        public Object invoke(Object proxy, 
        Method m, Object[] args) throws Throwable
        {
            Object result;
            try {
                System.out.print("begin method "
                 + m.getName() + "(");
                for(int i=0; i&lt;args.length; i++) {
                    if(i&gt;0) System.out.print(",");
                        System.out.print(" " + args[i].toString());
             }
             System.out.println(" )");
                 result = m.invoke(obj, args);
             } catch (InvocationTargetException e) {
                 throw e.getTargetException();
             } catch (Exception e) {
                 throw new RuntimeException
                 ("unexpected invocation exception: " +
                                            e.getMessage());
             } finally {
                 System.out.println(
                 "end method " + m.getName());
             }
             return result;
         }
     }
</PRE>
      <P>
      <H3>Conclusion</H3>
      <P>The proxy class is relatively flexible and straightforward to use, but 
      there are some distinct limitations on its use for method interposing. One 
      limitation is that the method must be called through an instance of the 
      proxy class. So nested methods calls, for instance, would not be 
      intercepted. Another limitation is that the method must have been defined 
      in an Interface that is implemented by the object being proxied. It can 
      not be called through an instance of a class that does not implement an 
      interface. The next article in this series will illustrate some techniques 
      for overcoming these limitations. 
      <P>
      <H3>About the Author</H3>
      <P><B>Tom Harpin</B> works in Market Development Engineering at Sun's 
      Burlington, MA campus. He works primarily on Distributed System Management 
      vendor integration efforts with WBEM, and JMX. Prior to Sun, Tom helped 
      design and implement several client-server systems for Delta Airlines. 
      <P>
      <H3>For More Information</H3>
      <P><A 
      href="http://docs.sun.com/ab2/coll.45.13/LLM/@Ab2PageView/4348?Ab2Lang=C&amp;Ab2Enc=iso-8859-1">Linkers 
      and Libraries Guide</A> 
      <P><A href="http://java.sun.com/j2se/1.3/docs/api/index.html">Proxy Class 
      Documentation</A><BR>(Scroll down to <CODE>java.lang.reflect</CODE> in the 
      top left box, click, then click on Proxy in the bottom left box) 
      <P>
      <HR>

      <P>
      <H3>Reader Feedback</H3>
      <P>Tell us what you think of this article. 
      <P><IMG align=left alt=Duke height=63 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/T7.gif" 
      width=85> 
      <FORM action=/servlet/jdc.survey.TabulationServlet method=post><INPUT 
      name=survey_id type=hidden value=2600> <INPUT name=anonymous type=hidden 
      value=True> <INPUT name=answer_count type=hidden value=3> <INPUT 
      name=answer1 type=hidden value=Interpose_a0701> <INPUT name=answer2 
      type=radio value=2> Very worth reading <INPUT name=answer2 type=radio 
      value=1> Worth reading <INPUT name=answer2 type=radio value=0> Not worth 
      reading 
      <P>If you have other comments or ideas for future articles, please type 
      them here: 
      <P><TEXTAREA cols=50 name=answer3></TEXTAREA> 
      <P><INPUT type=submit value=Submit> <INPUT type=reset value=Reset> </FORM>
      <P>Have a question about programming? Use <A 
      href="http://developer.java.sun.com/developer/support/index.html">Java 
      Online Support.</A> <!-- ================ --><!-- End Main Content --><!-- ================ --></FONT></P></TD></TR></TBODY></TABLE><!-- Copyright Insert --><BR 
clear=all>
<FORM action=/cgi-bin/search.cgi method=post>
<TABLE border=0 cellPadding=0 cellSpacing=5 width="100%">
  <TBODY>
  <TR>
    <TD vAlign=bottom><A 
      href="http://developer.java.sun.com/servlet/PrintPageServlet" 
      onclick="javascript:printpage();return false;"><IMG alt="Print Button" 
      border=0 height=25 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/printbutton.gif" 
      width=155></A> 
      <CENTER><FONT color=#999999 size=-1>[ This page was updated: <!-- new date -->18-Jul-2001 ] </FONT></CENTER></TD></TR>
  <TR>
    <TD bgColor=#cccccc><IMG alt="" height=1 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
      width=1></TD></TR>
  <TR>
    <TD>
      <CENTER><FONT size=-2><A href="http://java.sun.com/products/">Products 
      &amp; APIs</A> | <A 
      href="http://developer.java.sun.com/developer/index.html">Developer 
      Connection</A> | <A 
      href="http://developer.java.sun.com/developer/infodocs/">Docs &amp; 
      Training</A> | <A 
      href="http://developer.java.sun.com/developer/support/index.html">Online 
      Support</A><BR><A 
      href="http://developer.java.sun.com/developer/community/index.html">Community 
      Discussion</A> | <A href="http://java.sun.com/industry/">Industry News</A> 
      | <A href="http://java.sun.com/solutions">Solutions Marketplace</A> | <A 
      href="http://java.sun.com/casestudies">Case Studies</A> 
  </FONT></CENTER></TD></TR>
  <TR>
    <TD bgColor=#cccccc><IMG alt="" height=1 
      src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/pixel.gif" 
      width=1></TD></TR>
  <TR>
    <TD>
      <CENTER><FONT size=-2><A 
      href="http://java.sun.com/docs/glossary.html">Glossary</A> | <A 
      href="http://developer.java.sun.com/feedback/index.html">Feedback</A> | <A 
      href="http://java.sun.com/a-z/index.html">A-Z Index</A> 
  </FONT></CENTER></TD></TR>
  <TR>
    <TD>
      <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
        <TBODY>
        <TR>
          <TD width="50%"><FONT size=-2>For more information on Java 
            technology<BR>and other software from Sun Microsystems, 
            call:<BR></FONT><FONT size=-1>(800) 786-7638<BR></FONT><FONT 
            size=-2>Outside the U.S. and Canada, dial your country's <A 
            href="http://www.att.com/tollfree/international/dialguide/">AT&amp;T&nbsp;Direct&nbsp;Access&nbsp;Number</A> 
            first.<BR></FONT></TD>
          <TD align=right width="50%"><A href="http://www.sun.com/"><IMG 
            alt="Sun Microsystems, Inc." border=0 height=30 
            src="Using java_lang_reflect_Proxy to Interpose on Java Class Methods_files/lgsun.gif" 
            width=64></A><BR><FONT size=-2>Copyright © 1995-2001 <A 
            href="http://www.sun.com/">Sun Microsystems, Inc.</A><BR>All Rights 
            Reserved. <A 
            href="http://www.sun.com/share/text/termsofuse.html">Terms of 
            Use</A>. <A 
            href="http://www.sun.com/privacy/">Privacy&nbsp;Policy</A>. 
          </FONT></TD></TR></TBODY></TABLE></TD></TR></TBODY></TABLE></FORM><!-- End Copyright Insert --></BODY></HTML>
